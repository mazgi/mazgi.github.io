<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="shortcut icon" href="/common/favicon.ico">
    
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
    <link rel="stylesheet" href="/common/site.css">
    
    
    <title>mazgi.log :: One-Stop Web Service Development using Docker and Cloud Run</title>
    <meta property="og:title"       content="mazgi.log :: One-Stop Web Service Development using Docker and Cloud Run" />
    <meta property="og:type"        content="article" />
    
    <meta property="og:url"         content="https://mazgi.github.io/ja/posts/2020/10/one-stop-web-service-development-using-docker-and-cloud-run/" />
    
      
      <meta property="og:description" content="one-stop web service development using docker and cloud run" />
      
    
    
    
    
    
    
    
    
    
    
    
    <meta name="twitter:card"       content="summary" />
    
    
  </head>
  <body>
    <header class="navbar navbar-expand-lg navbar-dark bg-dark">
      
      <span class="navbar-text mr-1">I am on</span>
      
      <ul class="navbar-nav">
        
        <li class="nav-item">
          <a class="nav-link" target="github_mazgi" rel="noopener" href="https://github.com/mazgi">GitHub<i class="ml-1 fab fa-github"></i></a>
        </li>
        
        
        <li class="nav-item">
          <a class="nav-link" target="twitter_mazgi" rel="noopener" href="https://twitter.com/@mazgi">Twitter<i class="ml-1 fab fa-twitter"></i></a>
        </li>
        
        
        <li class="nav-item">
          <a class="nav-link" target="instagram_mazgi" rel="noopener" href="https://www.instagram.com/mazgi">Instagram<i class="ml-1 fab fa-instagram"></i></a>
        </li>
        
        
      </ul>
    </header>
    <nav class="navbar sticky-top navbar-expand-lg navbar-light bg-light">
      <a class="navbar-brand" href="https://mazgi.github.io/">mazgi.log</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar_nav" aria-controls="navbar_nav" aria-expand="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbar_nav">
        
        <ul class="navbar-nav mr-auto">
          
          
          
          <li class="nav-item">
            <span class="nav-link disabled">Created At: 2020.10.29</span>
          </li>
          <li class="nav-item">
            <span class="nav-link disabled">Updated At: 2023.04.17</span>
          </li>
          
        </ul>
        
        <div class="navbar-nav ml-auto">
          <span class="navbar-text mr-1">share this page via</span>
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link" href="https://twitter.com/share?url=https%3a%2f%2fmazgi.github.io%2fja%2fposts%2f2020%2f10%2fone-stop-web-service-development-using-docker-and-cloud-run%2f&text=One-Stop%20Web%20Service%20Development%20using%20Docker%20and%20Cloud%20Run" target="_blank" rel="noopener"><i class="fab fa-twitter"></i></a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fmazgi.github.io%2fja%2fposts%2f2020%2f10%2fone-stop-web-service-development-using-docker-and-cloud-run%2f" target="_blank" rel="noopener"><i class="fab fa-facebook"></i></a></a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="https://www.linkedin.com/shareArticle?url=https%3a%2f%2fmazgi.github.io%2fja%2fposts%2f2020%2f10%2fone-stop-web-service-development-using-docker-and-cloud-run%2f&title=One-Stop%20Web%20Service%20Development%20using%20Docker%20and%20Cloud%20Run" target="_blank" rel="noopener"><i class="fab fa-linkedin"></i></a></a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="https://plusone.google.com/_/+1/confirm?url=https%3a%2f%2fmazgi.github.io%2fja%2fposts%2f2020%2f10%2fone-stop-web-service-development-using-docker-and-cloud-run%2f" target="_blank" rel="noopener"><i class="fab fa-google-plus"></i></a></a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="https://b.hatena.ne.jp/entry/https://mazgi.github.io/ja/posts/2020/10/one-stop-web-service-development-using-docker-and-cloud-run/" target="_blank" rel="noopener">b!</a>
            </li>
          </ul>
        </div>
        
      </div>
    </nav>
    <main role="main" class="container-fluid col-lg-10 offset-lg-1">

<div class="row">
  <div class="col-lg-9">
    <article>
      <div class="row">
        <h1>One-Stop Web Service Development using Docker and Cloud Run</h1>
      </div>
      <p>この記事では <strong>GitHub</strong>, <strong>Docker</strong> そして <strong>Cloud Run</strong> を用いた Web アプリケーション開発と Deploy の方法を紹介します。</p>
<p>また本記事で紹介する構成はテンプレートを OSS として公開しています。<br>
そのためすぐに開発を始めることができ、また簡単な手順で継続的に Deploy を続けられます。</p>
<p>今回ご紹介する構成と仕組みは特にデモンストレーションや PoC のような軽量プロジェクトを複数扱う場合に有効です。</p>
<h2 id="resources">Resources</h2>
<p>この記事で扱うリソースは以下の <a href="https://docs.github.com/en/free-pro-team@latest/github/creating-cloning-and-archiving-repositories/creating-a-template-repository">GitHub template repository</a> として公開済みです。</p>
<ul>
<li><a href="https://github.com/mazgi/template.dockerized-provisioning-project">mazgi/template.dockerized-provisioning-project</a></li>
<li><a href="https://github.com/mazgi/template.dockerized-nextjs-project">mazgi/template.dockerized-nextjs-project</a></li>
<li><a href="https://github.com/mazgi/dockerfiles">mazgi/dockerfiles</a>
<ul>
<li><em>Docker image:</em> <a href="https://github.com/users/mazgi/packages/container/package/provisioning">provisioning</a></li>
<li><em>Docker image:</em> <a href="https://github.com/users/mazgi/packages/container/package/node-webapp.development">node-webapp.development</a></li>
</ul>
</li>
</ul>
<!-- raw HTML omitted -->
<h1 id="whats-cloud-run">What’s Cloud Run?</h1>
<p>はじめに「Cloud Run とは何か」「なぜ使うのか」を説明します。<br>
一方、この記事では十分に有名な <a href="https://github.com/">GitHub</a> と <a href="https://www.docker.com/">Docker</a> の紹介は割愛します。</p>
<p><a href="https://cloud.google.com/run">Cloud Run</a> は Google Cloud Platform 上で提供されている、Web システムのための軽量な Docker コンテナのホスティングサービスです。<br>
Cloud Run には<a href="https://cloud.google.com/run/docs/choosing-a-platform">”Fully Managed”と”Cloud Run for Anthos”の 2 種類</a>がありますが、今回は Fully Managed のみを扱います。</p>
<p>Cloud Run を使えば次のようにごく簡単な手順で任意の Docker コンテナをあなたの GCP プロジェクト上に Deploy し、全世界に公開できます。<br>
参考: <a href="https://cloud.google.com/sdk/gcloud/reference/run">https://cloud.google.com/sdk/gcloud/reference/run</a></p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">gcloud run deploy hello-cloud-run<span style="color:#4070a0;font-weight:bold">\
</span><span style="color:#4070a0;font-weight:bold"></span> --image gcr.io/cloudrun/hello<span style="color:#4070a0;font-weight:bold">\
</span><span style="color:#4070a0;font-weight:bold"></span> --platform managed<span style="color:#4070a0;font-weight:bold">\
</span><span style="color:#4070a0;font-weight:bold"></span> --region us-central1
</code></pre></div><p>経験豊富なあなたは「コマンドラインや手順ではなくコードでインフラストラクチャを管理し Deploy したい」と考えるかもしれません。</p>
<p>有名な Infrastructure as Code(IaC) のツールである <a href="https://www.terraform.io/">Terraform</a> を使う場合、次のようなコードで前述の例と同等の Deploy を行えます。<br>
(<a href="https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/cloud_run_service#example-usage---cloud-run-service-basic">Example Usage - Cloud Run Service Basic</a>より引用)</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-hcl" data-lang="hcl"><span style="color:#007020;font-weight:bold">resource</span> <span style="color:#4070a0">&#34;google_cloud_run_service&#34; &#34;default&#34;</span> {
  name     <span style="color:#666">=</span> <span style="color:#4070a0">&#34;cloudrun-srv&#34;</span>
  location <span style="color:#666">=</span> <span style="color:#4070a0">&#34;us-central1&#34;</span>

  <span style="color:#007020;font-weight:bold">template</span> {
    <span style="color:#007020;font-weight:bold">spec</span> {
      <span style="color:#007020;font-weight:bold">containers</span> {
        image <span style="color:#666">=</span> <span style="color:#4070a0">&#34;gcr.io/cloudrun/hello&#34;</span>
      }
    }
  }

  <span style="color:#007020;font-weight:bold">traffic</span> {
    percent         <span style="color:#666">=</span> <span style="color:#40a070">100</span>
    latest_revision <span style="color:#666">=</span> <span style="color:#902000">true</span>
  }
}
</code></pre></div><p>本記事でも Terraform の使用を想定します。</p>
<h2 id="cloud-run-の特徴">Cloud Run の特徴</h2>
<p>Cloud Run の特長はなんといっても ”Container to production in seconds” のキャッチコピー通り、極めて簡単に Docker コンテナを公開できることです。<br>
具体的には以下は利点でしょう。</p>
<ul>
<li>VPC などのネットワークの構築/設定不要</li>
<li>Docker コンテナに手を加えずホスティングできる
<ul>
<li>割り当てられたポート番号は PORT 環境変数で参照できます</li>
<li><a href="https://cloud.google.com/run/docs/reference/container-contract#env-vars">https://cloud.google.com/run/docs/reference/container-contract#env-vars</a></li>
<li><a href="https://cloud.google.com/run/docs/developing#code_requirements">https://cloud.google.com/run/docs/developing#code_requirements</a></li>
<li>デフォルトのポート番号は 8080 のようです</li>
<li><a href="https://cloud.google.com/run/docs/reference/container-contract#port">https://cloud.google.com/run/docs/reference/container-contract#port</a></li>
</ul>
</li>
<li>FQDN は自動生成される</li>
<li>もちろんカスタムドメインも設定可能</li>
<li>TLS 証明書も自動で発行/更新される</li>
<li>リクエストに応じて自動スケールされる
<ul>
<li><a href="https://cloud.google.com/run/docs/about-instance-autoscaling">https://cloud.google.com/run/docs/about-instance-autoscaling</a></li>
</ul>
</li>
<li>自動で起動&amp;停止され、トラフィックが発生しなければ費用も発生しない
<ul>
<li><a href="https://cloud.google.com/run/docs/reference/container-contract#lifecycle">https://cloud.google.com/run/docs/reference/container-contract#lifecycle</a></li>
<li><a href="https://cloud.google.com/run/pricing">https://cloud.google.com/run/pricing</a></li>
</ul>
</li>
</ul>
<p>一方で、Cloud Run には次の制約もあります。<br>
もしこれらの制約が要件を満たさないのであれば他のサービスを組み合わせるべきでしょう。</p>
<ul>
<li>データ永続化はできない
<ul>
<li>データの永続化には各種オブジェクトストレージやマネージド DBMS を併用します</li>
</ul>
</li>
<li>ジョブ実行には不向き
<ul>
<li>“Review your code to make sure all asynchronous operations finish before you deliver your response.” と書かれており HTTP レスポンスを返す前に全処理完了すべきです</li>
<li><a href="https://cloud.google.com/run/docs/tips/general#avoiding_background_activities">https://cloud.google.com/run/docs/tips/general#avoiding_background_activities</a></li>
</ul>
</li>
<li>Cloud Load Balancing には組み込めない
<ul>
<li>例えば <a href="https://example.com/cloud-run/">https://example.com/cloud-run/</a> へのリクエストだけ Cloud Run に割り振るような path mapping はできません</li>
</ul>
</li>
<li>コンテナオーケストレーションは限定的
<ul>
<li>オーケストレーションが必要になったら Kubernetes 等を検討すべきでしょう</li>
</ul>
</li>
<li>ライフサイクルやインスタンスタイプの細かいリソースチューニングは行えない</li>
<li>GPU は使用できない</li>
</ul>
<p>総じて「オーケストレーションするほどではない」フェイズの Web システムに適したプラットフォームです。</p>
<p>もし他にも簡単に Docker コンテナをホストできるプラットフォームがあれば教えてください。</p>
<h1 id="how-to-develop-web-services-for-docker-hosting-services">How to Develop Web Services for Docker Hosting Services?</h1>
<p>Cloud Run を使えば Docker コンテナをそのままホストできることがわかりました。<br>
では次に開発環境の Docker 化を考えます。</p>
<p>なぜ開発環境を Docker 化するのでしょうか。<br>
開発と Deploy の環境差異は少なければ少ないほど無用な問題に遭遇せずに済みます。<br>
例えば以下は代表的な遭遇したくない問題の例でしょう。</p>
<blockquote>
<p>「開発中は動いていたのに Deploy したら動かない！」<br>
「Deploy 環境での不具合を開発環境で Debug できない」<br>
「前任者から引き継いだ手順がうまくいかない、あるいは煩雑すぎる」</p>
</blockquote>
<p>開発から Deploy までを全て Docker 化することでこれらの問題の多くを回避できます。</p>
<h2 id="github-repositories">GitHub Repositories</h2>
<p>本記事の方法では Web システムの開発と Deploy を次の 2 つの GitHub repository で賄います。</p>
<ul>
<li><strong>Web Application Source Repository</strong>
<ul>
<li>Web アプリケーション自体のソースコードを管理する</li>
</ul>
</li>
<li><strong>Provisioning Repository</strong>
<ul>
<li>Provisioning 用のコードを管理する</li>
</ul>
</li>
</ul>
<p>冒頭に紹介したようにこれらは template repository として公開しています。</p>
<p>最初に誰かが <a href="https://docs.github.com/en/free-pro-team@latest/github/creating-cloning-and-archiving-repositories/creating-a-repository-from-a-template">template repository からプロジェクト用に GitHub repository を作れば</a>、以降は次の手順で開発と Deploy を行えます。</p>
<ol>
<li>Git 管理外のファイルを受け取る
<ul>
<li>例えば秘匿情報が書かれた <code>.env</code> file や credentials などです</li>
</ul>
</li>
<li><code>docker-compose up</code> する</li>
<li><code>docker-compose run xxx foo bar</code> する</li>
</ol>
<p>例えば以下のようなコマンドを実行することになるでしょう。</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker-compose run frontend npm run <span style="color:#007020">test</span>
</code></pre></div><div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker-compose run provisioning terraform plan
</code></pre></div><h2 id="web-application-source-repository">Web Application Source Repository</h2>
<p>まず Web アプリケーションのソースコードを管理する GitHub repository について説明します。</p>
<p>これは次の template repository として公開されています。<br>
<a href="https://github.com/mazgi/template.dockerized-nextjs-project">https://github.com/mazgi/template.dockerized-nextjs-project</a></p>
<p>この template repository は当然ながら Web アプリケーション開発の雛形として作られているので、次の手順で Web アプリケーションがローカル実行できます。</p>
<h3 id="1-env-file-を作る">1. .env file を作る</h3>
<p>template repository の README から引用します。<br>
開発環境として使っている Docker ホストに合わせて次の環境変数を設定します。</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">UID: Docker ホスト上の UID,
GID: Docker ホスト上の GID,
BIND_IP_ADDR: <span style="color:#007020">bind</span> したい Docker ホスト上の IP アドレス, 例: 192.0.2.1
PUBLIC_IP_ADDR_OR_FQDN: 多くの場合 BIND_IP_ADDR と同じ<span style="color:#666">(</span>後述<span style="color:#666">)</span>
</code></pre></div><h3 id="2-docker-compose-up">2) docker-compose up</h3>
<p>template では次の Docker Compose services が Docker ホストのネットワークに接続されて起動します。</p>
<ul>
<li>Web Frontend: <code>$BIND_IP_ADDR:3000</code></li>
<li>Web API(BFF): <code>$BIND_IP_ADDR:4000</code></li>
<li>MySQL: <code>$BIND_IP_ADDR:3306</code></li>
<li>Redis: <code>$BIND_IP_ADDR:6379</code></li>
</ul>
<p>つまり、Web ブラウザで <code>http://$BIND_IP_ADDR:3000</code> にアクセスすれば Frontend が表示され、<br>
<code>http://$BIND_IP_ADDR:4000</code> にアクセスすれば Web API が表示されます。</p>
<p>また MySQL クライアントを用いて <code>mysql -h \$BIND_IP_ADDR -u root</code> と実行することで Docker コンテナとして実行されている MySQL サーバーに接続することもできます。</p>
<h3 id="補足-開発サーバーの-ip-アドレスとポート">補足: 開発サーバーの IP アドレスとポート</h3>
<p>開発用の各種サーバーがどのように Docker ホストのネットワークに bind されるかは <code>.env</code> file の <code>BIND_IP_ADDR</code> 変数で指定します。<br>
一方でポートは <code>docker-compose.yml</code> 上で定義しており、プロジェクトごとに変えることは想定していません。</p>
<p>bind する IP アドレスは一般的に以下の方法で複数確保できます。</p>
<ul>
<li>IP aliasing</li>
<li>VirtualBox 等で VM を起動する</li>
<li>Google Compute Engine 等で VM を起動する</li>
</ul>
<p>IP alias は次のようなコマンドで設定できます。</p>
<p><strong>macOS:</strong></p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo ifconfig en0 <span style="color:#007020">alias</span> 192.0.2.1 255.255.255.0<span style="color:#4070a0">`</span>
</code></pre></div><p><strong>Linux(ifconfig command):</strong></p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo ifconfig eth0:1 192.0.2.1/24
</code></pre></div><p><strong>Linux(ip command):</strong></p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo ip addr add 192.0.2.1/24 dev eth0 label eth0:1
</code></pre></div><p>同じ template repository から作成したプロジェクト <code>a</code> と <code>b</code> を同時に開発するためには、IP アドレスかポート、少なくともいずれかを重複しないように設定する必要があります。</p>
<p>IP アドレスは最小 1 つしか割り当てられない一方、ポート番号は 65000 個ほど選べるため、プロジェクト <code>a</code> と <code>b</code> で IP アドレスではなくポート番号を変更したいと思うかもしれません。<br>
しかし、次の理由でポート番号は固定しておく方が利便性が高いと考えています。</p>
<p>例えば MySQL には <code>3306</code>、Redis には <code>6379</code> といった標準的なポート番号があります。<br>
ポート番号を標準から変更しなければツール使用時にオプションを指定する必要もありませんし、プロジェクトを移った際に「このプロジェクトの mysql port は <code>3306</code> だったか、それとも <code>13306</code> だったか」と確認する必要もありません。</p>
<p>またプロジェクトごとにポート番号オフセットして回ることはわかりづらく、私にような忘れっぽい人間はポート番号の変更や重複に気付かず発生したトラブルに時間を費やさずに済みます。<br>
チーム開発する上で IP アドレスだけ教えてもらえば他の人の環境でもエンドポイントがわかることは便利です。</p>
<h3 id="補足-bind_ip_addr-と-public_ip_addr_or_fqdn-が異なる場合">補足: BIND_IP_ADDR と PUBLIC_IP_ADDR_OR_FQDN が異なる場合</h3>
<p>大抵の場合、<code>.env</code> file の <code>PUBLIC_IP_ADDR_OR_FQDN</code> には <code>BIND_IP_ADDR</code> と同じローカル IP アドレス、例えば <code>192.0.2.1</code> などを指定すれば問題ありません。<br>
しかしクラウドサービス上の VM のように NAT 経由でアクセスする場合は適した IP アドレスを指定する必要があります。</p>
<p>例えばあなたのインスタンスのローカル IP アドレスが <code>192.0.2.1</code> で NAT で割り当てられたグローバル IP アドレスが <code>203.0.113.1</code> であるなら、これらを <code>.env</code> file に書く必要があります。</p>
<!-- raw HTML omitted -->
<h3 id="補足-プロジェクト内にサービスを追加する方法">補足: プロジェクト内にサービスを追加する方法</h3>
<p>もし Docker Compose で起動される新たなサービス <code>$SERVICE</code> を追加する場合は以下が必要です。</p>
<ol>
<li>GitHub repository 直下にソースコードディレクトリ <code>$SERVICE/</code> を作る</li>
<li>開発用 Dockerfile <code>Dockerfile.d/$SERVICE.development/Dockerfile</code> を作る</li>
<li>Deploy 用 Dockerfile <code>Dockerfile.d/$SERVICE/Dockerfile</code> を作る</li>
<li><code>docker-compose.yml</code> を編集して <code>$SERVICE</code> を追加する</li>
<li><code>.github/workflows/*.yml</code> を編集して GitHub Actions で <code>$SERVICE</code> の CI/CD を設定する</li>
</ol>
<p>ただし Deploy 用の Dockerfile は現在のところ template repository では未定義です。</p>
<h2 id="provisioning-repository">Provisioning Repository</h2>
<p>次に Provisioning 用のコードを管理する GitHub repository について説明します。<br>
これは次の template repository として公開されています。<br>
<a href="https://github.com/mazgi/template.dockerized-provisioning-project">https://github.com/mazgi/template.dockerized-provisioning-project</a></p>
<p>この GitHub repository では主に Terraform のコードを管理します。</p>
<p>template repository には以下を行う <code>tf</code> ファイルが <code>provisioning/examples</code> にサンプルとして配置されています。</p>
<ul>
<li>Terraform 自体の設定
<ul>
<li>各種 Terraform provider のバージョン指定</li>
<li>GCS に tfstate ファイルを格納</li>
</ul>
</li>
<li>GitHub Actions 向けのシステムユーザー作成</li>
<li>Cloud DNS による DNS ゾーン設定</li>
<li>Amazon SES の設定</li>
</ul>
<p>これらのサンプルを必要に応じて 1 階層上の <code>provisioning</code> に移動することで適用の対象となります。</p>
<h3 id="初期構築の例">初期構築の例</h3>
<p>Template repository を使用して GitHub repository を作った後は次の手順で provisioning を開始でき、必要なら GitHub Actions 上で自動適用も行えます。</p>
<ol>
<li>credentials と <code>.env</code> file 配置</li>
<li><code>provisioning/examples/*</code> から必要なファイルを <code>provisioning/</code> にコピー</li>
<li><code>docker-compose up</code>
<ul>
<li>ステータスが <code>0</code> で返って終了すれば正常です</li>
</ul>
</li>
<li>一度 local で apply</li>
<li>GitHub Actions 向けの credentials が払い出されるので <a href="https://docs.github.com/en/free-pro-team@latest/actions/reference/encrypted-secrets">GitHub repository の secrets</a> に登録</li>
</ol>
<p>以降は <code>main</code> branch に commit が push されると GitHub Actions で <code>terraform plan</code> や <code>terraform apply</code> が行われます。</p>
<h3 id="運用方法の例">運用方法の例</h3>
<p>前述の初期構築が完了した GitHub repository であれば次の 3 ステップで provisioning を行えます。</p>
<ol>
<li>credentials と <code>.env</code> file を受け取る</li>
<li><code>docker-compose up</code> して正常終了を待つ</li>
<li><code>docker-compose run provisioning terraform apply</code> を実行する</li>
</ol>
<h3 id="補足-init-script">補足: Init script</h3>
<p>docker-compose up 時に実行される初期化スクリプト内で次のことを行なっています。<br>
<a href="https://github.com/mazgi/template.dockerized-provisioning-project/blob/main/scripts/provisioning.init-with-google.sh">https://github.com/mazgi/template.dockerized-provisioning-project/blob/main/scripts/provisioning.init-with-google.sh</a></p>
<ol>
<li>GCP service account の認証</li>
<li>GCS bucket の作成</li>
<li><code>terraform init</code> 実行</li>
</ol>
<h3 id="terraform-実行を-docker-上で行う理由">Terraform 実行を Docker 上で行う理由</h3>
<p>Terraform はとてもポータビリティに優れたツールで、Linux, macOS や Windows 向けにもシングルバイナリで提供されています。<br>
一見、Docker 上で実行するメリットは少ないと感じるかもしれません。</p>
<p>しかし Terraform 単体ではなく「provisioning を行う環境」として考えると Docker に閉じることにはメリットがあります。</p>
<p><strong>1 つは秘匿情報が .env file と credentilas に閉じることです。</strong></p>
<p>プロジェクト内の gitignore された特定の path に credentials を配置するだけですぐに目的の環境に向けて provisioning できますし、誤って異なる環境に向けて provisioning してしまうリスクを軽減できます。</p>
<p>きっと多くの方が <code>gcloud config set project</code> し忘れたり思わぬ環境変数が <code>export</code> されていて冷や汗をかいた経験があるのではないでしょうか。</p>
<p><strong>もう 1 つのメリットは環境差異の吸収です。</strong></p>
<p>環境やバージョンによる差異はシェルスクリプトですら深刻な影響をもたらすことがあります。<br>
例えば Linux と macOS での Bash バージョンの違いや、<code>jq</code> などある人にとっては「インストールされていることが当たり前」なツールの有無による差異で悩んだことは誰しもあるのではないでしょうか。</p>
<p>実際のところ、プロジェクトに新しく参加した方の <code>sed</code> や <code>awk</code> が BSD 版/GNU 版であることに気付かず消費された時間は通勤時間の次に勿体無いと思っています。</p>
<p>provisioning を行う環境すら Docker に隠蔽することでこれらの問題を大きく軽減することができます。</p>
<p>これらのメリットは GitHub Actions のような CI/CD を設定する上でも有用です。<br>
実際のところ、 <code>.env</code> file を書き出すように設定し credentials を secrets に登録するだけで、すぐに CI/CD を開始できます。</p>
<h1 id="その他補足事項とまとめ">その他補足事項とまとめ</h1>
<p>本項ではここまでの内容から漏れたいくつかの補足を記載します。</p>
<p><strong>IDE/エディタは Visual Studio Code を想定</strong></p>
<p>私は近年 <a href="https://code.visualstudio.com/">Visual Studio Code(VSCode)</a> を好んで使っています。<br>
特に JavaScript や TypeScript で開発する際は prettier と eslint を VSCode の extensions から参照できるよう考慮しています。</p>
<p>しかし template repository は特に VSCode でなければ使えないような構成にはなっていません。<br>
お好きな IDE やエディタを使って開発できます。</p>
<p>また template repository は <a href="https://code.visualstudio.com/docs/remote/containers">Visual Studio Code Remote - Containers</a> 向けには構成されていません。</p>
<p>Visual Studio Code Remote - Containers は開発を容易にする優れた機能ですが、 1 つの Docker コンテナにしか接続できません。<br>
そのため本記事で紹介する用途と構成には向いていません。</p>
<p><strong>Docker コンテナは開発用と Deploy 用で分ける</strong></p>
<p>開発用 Docker コンテナは使いやすさを重視しサイズが肥大化することをある程度許容しています。<br>
私が実際に使っている開発用の Dockerfile を次の GitHub repository に集約されており、GitHub Actions で自動ビルドされ ghcr.io で公開されています。<br>
<a href="https://github.com/mazgi/dockerfiles">https://github.com/mazgi/dockerfiles</a></p>
<p>Deploy 用の Dockerfile では Alpine 等の軽量な Linux ディストリビュージョンをベースイメージとして使うことが多いですが現時点では template repository には組み込めていません。</p>
<p><strong>Docker 単体ではなく Docker Compose を使う</strong></p>
<p>Docker コマンド、覚えてますか?<br>
私が覚えているコマンドは <code>docker run -it -p --rm -v -w</code> 程度です。</p>
<p>Docker コマンドの全てを覚えなくても <code>docker-compose.yml</code> に 1 度書いておけば <code>up</code>, <code>run</code>, <code>down</code> 程度を使い分ければ済みます。</p>
<p><strong>2020 年の Web 開発用 OS は Linux こそ至高</strong></p>
<p>Docker はその仕組み上、ホスト OS とコンテナで Linux kernel を共用します。<br>
これは Docker に限った話ではなく LXC 等のコンテナ技術全般に言える話です。</p>
<p>そのため Docker の Linux 向けコンテナを macOS や Windows 上で動かす際には、macOS や Windows 上で Linux VM を起動させ、その Linux VM 上で Docker コンテナを動作させることになります。<br>
GUI などで使い勝手よく工夫されてはいますが、この仕組み自体は変わりません。</p>
<p>そのため、Docker コンテナのファイル I/O は macOS や Windows 上では非常に性能が落ちます。<br>
この性能低下は前述のように Docker とコンテナ自体の構造に根ざしているため、当面は大きく改善しないでしょう。<br>
ネットワーク構成やコストが許せば Linux がインストールされた PC や Goole Compute Engine のような VM を用意することで快適に開発を進められます。</p>
<p>冒頭に書いたように本記事では、デモンストレーションや PoC のような軽量な複数の Web アプリケーションプロジェクトを、いかに継続的に容易に扱うかを考え試した内容をご紹介したものです。<br>
もし本記事の内容や template repository が私と同じ悩みを抱えたどなたかのお役に立てば幸いです。</p>

    </article>
  </div>
  <div class="col-lg-3">
    <div class="sidebar">
  
  <h4><a href="/ja/about/">About</a></h4>
  <p><strong>Hidenori MATSUKI</strong></p>
<p>🍣 🍶</p>
<p>another website: <a href="https://mazgi.com/">mazgi.com</a></p>
  
  <hr />
  <h4>TableOfContents</h4>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#resources">Resources</a></li>
  </ul>

  <ul>
    <li><a href="#cloud-run-の特徴">Cloud Run の特徴</a></li>
  </ul>

  <ul>
    <li><a href="#github-repositories">GitHub Repositories</a></li>
    <li><a href="#web-application-source-repository">Web Application Source Repository</a>
      <ul>
        <li><a href="#1-env-file-を作る">1. .env file を作る</a></li>
        <li><a href="#2-docker-compose-up">2) docker-compose up</a></li>
        <li><a href="#補足-開発サーバーの-ip-アドレスとポート">補足: 開発サーバーの IP アドレスとポート</a></li>
        <li><a href="#補足-bind_ip_addr-と-public_ip_addr_or_fqdn-が異なる場合">補足: BIND_IP_ADDR と PUBLIC_IP_ADDR_OR_FQDN が異なる場合</a></li>
        <li><a href="#補足-プロジェクト内にサービスを追加する方法">補足: プロジェクト内にサービスを追加する方法</a></li>
      </ul>
    </li>
    <li><a href="#provisioning-repository">Provisioning Repository</a>
      <ul>
        <li><a href="#初期構築の例">初期構築の例</a></li>
        <li><a href="#運用方法の例">運用方法の例</a></li>
        <li><a href="#補足-init-script">補足: Init script</a></li>
        <li><a href="#terraform-実行を-docker-上で行う理由">Terraform 実行を Docker 上で行う理由</a></li>
      </ul>
    </li>
  </ul>
</nav>
  <hr />
  <h4><a href="/ja/categories/">Categories</a></h4>
  
  <hr />
  <h4><a href="/ja/tags/">Tags</a></h4>
  
</div>

  </div>
</div>
      <div class="row">
        <footer class="col-lg-12">
          <hr/>
          <span>&copy; mazgi.log</span>
          <span>&nbsp;&middot;&nbsp;</span>
          <i class="fas fa-bolt"></i>
          <span>Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a></span>
          
          <span>&nbsp;&middot;&nbsp;</span>
          <span>This website <a href="https://policies.google.com/technologies/partner-sites" target="_blank" rel="noopener">uses Google Analytics</a>.</span>
          
        </footer>
      </div>
    </div>
    </main>
    
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-68170979-2"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-68170979-2');
    </script>
    
      
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    
    <script defer src="https://use.fontawesome.com/releases/v5.0.8/js/all.js" integrity="sha384-SlE991lGASHoBfWbelyBPLsUlwY1GwNDJo3jSJO04KZ33K2bwfV9YBauFfnzvynJ" crossorigin="anonymous"></script>
    
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
      });
    </script>
  </body>
</html>

