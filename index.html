<!DOCTYPE html>
<html lang="en">
  <head>
	<meta name="generator" content="Hugo 0.37.1" />
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
    
    
    <title>mazgi.log</title>
    <meta property="og:title"       content="mazgi.log" />
    <meta property="og:type"        content="website" />
    
    <meta property="og:url"         content="https://mazgi.github.io/" />
    <meta property="og:description" content="" />
    
    
    
    
    
    
    
    
    
    
    <meta name="twitter:card"       content="summary" />
    
    <meta name="twitter:site"       content="@mazgi" />
    
    
  </head>
  <body>
    <header class="navbar navbar-expand-lg navbar-dark bg-dark">
      <ul class="navbar-nav">
        
      </ul>
    </header>
    <nav class="navbar sticky-top navbar-expand-lg navbar-light bg-light">
      <a class="navbar-brand" href="https://mazgi.github.io/">mazgi.log</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar_nav" aria-controls="navbar_nav" aria-expand="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbar_nav">
        
        <ul class="navbar-nav mr-auto">
          
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbar_dropdown_lang" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              翻訳を表示
            </a>
            <div class="dropdown-menu" aria-labelledby="navbar_dropdown_lang">
              
              <a class="dropdown-item" href="https://mazgi.github.io/en/">
                <span class="badge badge-light">English</span>
                mazgi.log
              </a>
              
            </div>
          </li>
          
          
        </ul>
        
        <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <a class="nav-link" href="https://twitter.com/share?url=https%3a%2f%2fmazgi.github.io%2f&text=mazgi.log" target="_blank">tw</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fmazgi.github.io%2f" target="_blank">fb</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="https://www.linkedin.com/shareArticle?url=https%3a%2f%2fmazgi.github.io%2f&title=mazgi.log" target="_blank">in</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="https://plusone.google.com/_/+1/confirm?url=https%3a%2f%2fmazgi.github.io%2f" target="_blank">g+</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="https://b.hatena.ne.jp/entry/https://mazgi.github.io/" target="_blank">b!</a>
          </li>
        </ul>
        
      </div>
    </nav>
    <main role="main" class="container-fluid col-lg-10 offset-lg-1">

<div class="row">
  <div class="col-lg-9">
    
    
    <article>
      <div class="row">
        <h1><a href="/posts/2018.03/setup-amazon-sagemaker/">Amazon SageMakerをそれなりの人数で使うときの設定</a></h1>
      </div>
      

<p>AWSのマネージドJupyterサービスである「Amazon SageMaker」を数十名規模で使う機会があったのでインフラ的に設定した内容などを書いておく。<br />
<del>SageMakerで何をしたかなどはいずれちゃんとした情報が出ると思う。</del> 出ました！<br />
=&gt; <a href="https://engineer.dena.jp/2018/03/amazon-sagemaker.html">Amazon SageMaker ハンズオンレポート</a></p>

<h1 id="amazon-sagemakerとは">Amazon SageMakerとは?</h1>

<p>AWSのWebUIでぽちぽちクリックしていくとJupyterが起動する、そういうやつです。<br />
SageMakerのオフィシャルサイトはこちら。<br />
<a href="https://aws.amazon.com/jp/sagemaker/">機械学習モデルとアルゴリズム | AWS での Amazon SageMaker</a></p>

<h1 id="amazon-sagemakerの起動方法">Amazon SageMakerの起動方法</h1>

<p>まずアクセスすべきはこちら。<br />
<a href="https://console.aws.amazon.com/sagemaker/home#/notebook-instances">https://console.aws.amazon.com/sagemaker/home#/notebook-instances</a></p>

<p>「Create notebook instance」ボタンをクリックするとこのような画面になるので項目を埋めていく。<br />

<figure>
    
        <img src="/posts/2018.03/setup-amazon-sagemaker/0001.png" />
    
    
</figure>
</p>

<p>ある程度の人数で使う場合には以下のような項目を取り決めておくと良さそう。</p>

<ul>
<li>Notebook instance name

<ul>
<li>文字通りNotebookインスタンスの名前になるほか、Jupyter NotebookのURLの一部としても使われる</li>
<li>誰が作ったかとか何の目的なのかとか命名ルールを決めておくと良さそう</li>
</ul></li>
<li>Notebook instance type

<ul>
<li>いくつか選べる</li>
<li>Notebookインスタンスは純粋にNotebookであって、このインスタンスでjobが動くわけではないのでそんなに強力なインスタンスでなくてもよい</li>
<li>なお実際にjobを実行するインスタンスでは p2/p3 などのGPUインスタンスも選べる</li>
</ul></li>
<li>IAM role(後述)

<ul>
<li>Notebookインスタンスに与えるRole、この権限でjobなどのインスタンスを作ろうとする</li>
<li>Roleを作成するか既存のRoleから選択するかなどが選べる</li>
<li>チームやグループで使うのであればあらかじめRoleを作っておいてARNを入力してもらう方が管理上よいと思う</li>
</ul></li>
<li>Custom IAM role ARN

<ul>
<li>前述の「IAM role」で既存のRoleを選ぶことにすると表示される</li>
<li>私はあらかじめ作っておいたRoleを入力してもらうことにした</li>
</ul></li>
<li>VPC

<ul>
<li>とりあえず使うだけなら <code>No VPC</code> でよい</li>
<li>ここで指定したVPCにSageMakerがアクセスできるようになるらしい(未検証)</li>
<li>&ldquo;Notebook instances will have internet access independent of your VPC setting.&ldquo;とある通り、ここでVPCを指定したからといってSageMakerやNotebookを特定のVPCに閉じ込めることはできないので注意</li>
</ul></li>
</ul>

<p>以上のような項目を埋めて、ページ下部の「Create notebook instance」ボタンをクリックするとNotebookインスタンスが準備されるので「InService」になるまで数分〜10数分程度待つ。<br />
案外時間がかかるが裏側でプロビジョニングなどを行なっているのでしょう。</p>

<p>「InService」になったNotebookインスタンスの詳細をみると右上に「Open」ボタンがあるのでクリックする。<br />

<figure>
    
        <img src="/posts/2018.03/setup-amazon-sagemaker/0002.png" />
    
    
</figure>
</p>

<p>そうすると別タブで見慣れたJupyter Notebookの画面が開くので好きなように使う。<br />

<figure>
    
        <img src="/posts/2018.03/setup-amazon-sagemaker/0003.png" />
    
    
</figure>
</p>

<p>こんなに楽だと自分でJupyter Notebook立てるモチベーションがなくなって良いですね。</p>

<h1 id="iam-role-group作成">IAM Role/Group作成</h1>

<p>以下を用意した</p>

<ul>
<li>IAM Role

<ul>
<li>前述の、Notebookインスタンスに与えるRole</li>
<li>最小限 <code>AmazonSageMakerFullAccess</code> をアタッチしておけば良い</li>
</ul></li>
<li>IAM Group

<ul>
<li>今回は1つのAWSアカウントで数十名が同時にSageMakerを使うため、グループを作ってユーザーを紐づけることにした</li>
<li>以下をアタッチした(もう少し絞り込めそうではある)</li>
<li><code>AmazonSageMakerFullAccess</code></li>
<li><code>AmazonEC2FullAccess</code></li>
<li><code>IAMReadOnlyAccess</code></li>
<li><code>IAMUserChangePassword</code> (これは運用上必要だっただけ)</li>
</ul></li>
<li>IAM User(s)

<ul>
<li>SageMakerを使う人全員分のユーザーを払い出し、前述のグループに紐付けた</li>
<li>今回は初期パスワードを私の手元でコンソール出力し、各自初回ログイン時に変更してもらった</li>
</ul></li>
</ul>

<p>以上の設定をTerraformで行う <code>.tf</code> ファイルの例は次の通り。<br />
内容はほぼそのまま、個々のユーザー名は別途変数から読んでいる。</p>

<script src="//gist.github.com/mazgi/aebcf7cac9ed5ca5f3f1d0f69557a820.js"></script>

<h1 id="awsリソース上限緩和申請">AWSリソース上限緩和申請</h1>

<p>AWS SAの方にご相談の上、SageMakerを利用する <code>IAM User数 * n</code> で事前にリソース上限の緩和申請を行なった。<br />
デフォルト値はこちら。<br />
<a href="https://docs.aws.amazon.com/ja_jp/general/latest/gr/aws_service_limits.html#limits_sagemaker">AWS サービス制限 - アマゾン ウェブ サービス#Amazon SageMaker の制限</a></p>

<p>内容はざっと次の通り。<br />
各ユーザーがNotebookインスタンスを1つ、学習と推論のjobを2つずつ実行することを想定した。</p>

<ul>
<li>SageMaker のホスト

<ul>
<li>インスタンス数: <code>IAM User数 * 3</code></li>
<li>(使用するインスタンスタイプ): <code>IAM User数 * 3</code></li>
<li>エンドポイントのインスタンス数: <code>IAM User数 * 3</code></li>
<li><em>これは不要だったようだ</em></li>
</ul></li>
<li>SageMaker のトレーニング

<ul>
<li>インスタンス数: <code>IAM User数 * 3</code></li>
<li>トレーニングジョブのインスタンス数: <code>IAM User数 * 3</code></li>
<li>(使用するインスタンスタイプ): <code>IAM User数 * 3</code></li>
</ul></li>
<li>SageMaker ノートブック

<ul>
<li>(使用するインスタンスタイプ): <code>IAM User数 * 1.5</code></li>
<li>実行中のノートブックインスタンスの数: <code>IAM User数 * 1.5</code></li>
</ul></li>
</ul>

<p>一部CloudTrailの上限に引っかかり同時実行できなかったりもしたが、概ねこれでユーザー全員が目的の操作を行えた。<br />
AWSのリソース上限はなかなか難しいのでAWS SAの方に相談するに限る🙏</p>

<h1 id="感想">感想</h1>

<p>プロビジョニングしてルールを決めておけば使いたい人にサクッと使ってもらえて大変便利。<br />
各種セキュリティ担保の方法や込み入った使い方については今後使ってもらいながら工夫していきたい。</p>

    </article>
    
    <hr/>
    
    
    <article>
      <div class="row">
        <h1><a href="/posts/2018.03/s3fs-for-s3-with-sse-kms/">SSE-KMSで暗号化したS3バケットをs3fsでmountする</a></h1>
      </div>
      

<p>タイトルの通り「AWS Key Management Service (AWS KMS) 」を使って暗号化したAmazon S3バケットをs3fsでUbuntu 16上でmountした。<br />
KMSについては以下のドキュメントが詳しいが要は暗号化の際に煩雑な鍵の管理をAWSにお願いできる仕組み。</p>

<p><a href="https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/dev/UsingKMSEncryption.html">AWS KMS で管理されたキーによるサーバー側の暗号化 (SSE-KMS) を使用したデータの保護 - Amazon Simple Storage Service</a></p>

<h1 id="s3バケットの準備">S3バケットの準備</h1>

<p>S3バケットを作り、画像のように <code>Default encryption</code> を <code>AWS-KMS</code> に設定する。<br />
なおこのS3バケットは記事公開時点で削除済み。</p>


<figure>
    
        <img src="/posts/2018.03/s3fs-for-s3-with-sse-kms/0001.png" />
    
    
</figure>


<h1 id="s3fsの設定">s3fsの設定</h1>

<h2 id="install">Install</h2>

<p>GitHubからアーカイブをダウンロードして</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ./autogen.sh
$ ./configure
$ make
$ sudo make install</code></pre></div>

<p>する。</p>

<p><a href="https://github.com/s3fs-fuse/s3fs-fuse/releases/tag/v1.83">Release Release verson 1.83 · s3fs-fuse/s3fs-fuse</a></p>

<h2 id="mount">mount</h2>

<p>以下のようにAWSのcredentialを <code>.secret</code> というファイルに <code>ACCESS_KEY:SECRET_KEY</code> というフォーマットで書く。<br />
またKMSの鍵IDを環境変数に設定した。</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cat .secret
****ACCESS_KEY****:****SECRET_KEY****
$ export AWSSSEKMSID<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;********&#39;</span></code></pre></div>

<p>そしてmountする。<br />
<code>endpoint</code>, <code>uid</code>, <code>gid</code> , <code>umask</code> あたりをきちんと設定しないと読み書きできない、ハマった。<br />
なお鍵IDは環境変数使わなくても <code>use_sse=kmsid:&quot;${AWSSSEKMSID}&quot;</code> でいける模様。</p>

<p>また <code>-d</code> はdebug、 <code>-f</code> はフォアグラウンド実行。</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ s3fs mazgi-s3-sse-kms-test-01-bucket-01 bucket -o passwd_file<span style="color:#f92672">=</span>.secret,use_sse<span style="color:#f92672">=</span>kmsid,endpoint<span style="color:#f92672">=</span>ap-northeast-1,allow_other,uid<span style="color:#f92672">=</span><span style="color:#ae81ff">1234</span>,gid<span style="color:#f92672">=</span><span style="color:#ae81ff">1234</span>,umask<span style="color:#f92672">=</span><span style="color:#ae81ff">227</span> -d -f
<span style="color:#f92672">[</span>CRT<span style="color:#f92672">]</span> s3fs.cpp:set_s3fs_log_level<span style="color:#f92672">(</span><span style="color:#ae81ff">271</span><span style="color:#f92672">)</span>: change debug level from <span style="color:#f92672">[</span>CRT<span style="color:#f92672">]</span> to <span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span> 
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>     s3fs.cpp:set_mountpoint_attribute<span style="color:#f92672">(</span><span style="color:#ae81ff">4206</span><span style="color:#f92672">)</span>: PROC<span style="color:#f92672">(</span>uid<span style="color:#f92672">=</span><span style="color:#ae81ff">4600</span>, gid<span style="color:#f92672">=</span><span style="color:#ae81ff">4600</span><span style="color:#f92672">)</span> - MountPoint<span style="color:#f92672">(</span>uid<span style="color:#f92672">=</span><span style="color:#ae81ff">4600</span>, gid<span style="color:#f92672">=</span><span style="color:#ae81ff">4600</span>, mode<span style="color:#f92672">=</span><span style="color:#ae81ff">40775</span><span style="color:#f92672">)</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span> s3fs.cpp:s3fs_init<span style="color:#f92672">(</span><span style="color:#ae81ff">3371</span><span style="color:#f92672">)</span>: init v1.83<span style="color:#f92672">(</span>commit:unknown<span style="color:#f92672">)</span> with OpenSSL
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span> s3fs.cpp:s3fs_check_service<span style="color:#f92672">(</span><span style="color:#ae81ff">3747</span><span style="color:#f92672">)</span>: check services.
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:CheckBucket<span style="color:#f92672">(</span><span style="color:#ae81ff">3068</span><span style="color:#f92672">)</span>: check a bucket.
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:prepare_url<span style="color:#f92672">(</span><span style="color:#ae81ff">4253</span><span style="color:#f92672">)</span>: URL is https://s3.amazonaws.com/mazgi-s3-sse-kms-test-01-bucket-01/
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:prepare_url<span style="color:#f92672">(</span><span style="color:#ae81ff">4285</span><span style="color:#f92672">)</span>: URL changed is https://mazgi-s3-sse-kms-test-01-bucket-01.s3.amazonaws.com/
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:insertV4Headers<span style="color:#f92672">(</span><span style="color:#ae81ff">2400</span><span style="color:#f92672">)</span>: computing signature <span style="color:#f92672">[</span>GET<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>/<span style="color:#f92672">]</span> <span style="color:#f92672">[]</span> <span style="color:#f92672">[]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:url_to_host<span style="color:#f92672">(</span><span style="color:#ae81ff">101</span><span style="color:#f92672">)</span>: url is https://s3.amazonaws.com
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:RequestPerform<span style="color:#f92672">(</span><span style="color:#ae81ff">2051</span><span style="color:#f92672">)</span>: HTTP response code <span style="color:#ae81ff">200</span></code></pre></div>

<h2 id="ファイル操作">ファイル操作</h2>

<p><code>ls</code> してみる。</p>

<p>なおS3バケットに入っているJPEG画像はこれ。かわいい。<br />
「<a href="https://www.pakutaso.com/">ぱくたそ</a>」からお借りした。</p>

<p>
<figure>
    
        <img src="/posts/2018.03/s3fs-for-s3-with-sse-kms/0002.jpeg" />
    
    
</figure>
</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ls -l bucket
total <span style="color:#ae81ff">179</span>
-r-xr-x--- <span style="color:#ae81ff">1</span> user group <span style="color:#ae81ff">96870</span> Feb  <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">07</span>:10 cat.jpg*
-r-xr-x--- <span style="color:#ae81ff">1</span> user group <span style="color:#ae81ff">84999</span> Feb  <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">07</span>:13 cat_plain.jpg*</code></pre></div>

<p>その時のコンソールログ。</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span> s3fs.cpp:s3fs_getattr<span style="color:#f92672">(</span><span style="color:#ae81ff">841</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>path<span style="color:#f92672">=</span>/<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span> s3fs.cpp:s3fs_opendir<span style="color:#f92672">(</span><span style="color:#ae81ff">2281</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>path<span style="color:#f92672">=</span>/<span style="color:#f92672">][</span>flags<span style="color:#f92672">=</span><span style="color:#ae81ff">100352</span><span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span> s3fs.cpp:s3fs_readdir<span style="color:#f92672">(</span><span style="color:#ae81ff">2432</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>path<span style="color:#f92672">=</span>/<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>   s3fs.cpp:list_bucket<span style="color:#f92672">(</span><span style="color:#ae81ff">2477</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>path<span style="color:#f92672">=</span>/<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:ListBucketRequest<span style="color:#f92672">(</span><span style="color:#ae81ff">3103</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>tpath<span style="color:#f92672">=</span>/<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:prepare_url<span style="color:#f92672">(</span><span style="color:#ae81ff">4253</span><span style="color:#f92672">)</span>: URL is https://s3.amazonaws.com/mazgi-s3-sse-kms-test-01-bucket-01?delimiter<span style="color:#f92672">=</span>/&amp;max-keys<span style="color:#f92672">=</span><span style="color:#ae81ff">1000</span>&amp;prefix<span style="color:#f92672">=</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:prepare_url<span style="color:#f92672">(</span><span style="color:#ae81ff">4285</span><span style="color:#f92672">)</span>: URL changed is https://mazgi-s3-sse-kms-test-01-bucket-01.s3.amazonaws.com?delimiter<span style="color:#f92672">=</span>/&amp;max-keys<span style="color:#f92672">=</span><span style="color:#ae81ff">1000</span>&amp;prefix<span style="color:#f92672">=</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:insertV4Headers<span style="color:#f92672">(</span><span style="color:#ae81ff">2400</span><span style="color:#f92672">)</span>: computing signature <span style="color:#f92672">[</span>GET<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>/<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>delimiter<span style="color:#f92672">=</span>/&amp;max-keys<span style="color:#f92672">=</span><span style="color:#ae81ff">1000</span>&amp;prefix<span style="color:#f92672">=]</span> <span style="color:#f92672">[]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:url_to_host<span style="color:#f92672">(</span><span style="color:#ae81ff">101</span><span style="color:#f92672">)</span>: url is https://s3.amazonaws.com
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:RequestPerform<span style="color:#f92672">(</span><span style="color:#ae81ff">2051</span><span style="color:#f92672">)</span>: HTTP response code <span style="color:#ae81ff">200</span>
<span style="color:#f92672">[</span>WAN<span style="color:#f92672">]</span> s3fs.cpp:append_objects_from_xml_ex<span style="color:#f92672">(</span><span style="color:#ae81ff">2575</span><span style="color:#f92672">)</span>: contents_xp-&gt;nodesetval is empty.
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>   s3fs.cpp:readdir_multi_head<span style="color:#f92672">(</span><span style="color:#ae81ff">2346</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>path<span style="color:#f92672">=</span>/<span style="color:#f92672">][</span>list<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span><span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:PreHeadRequest<span style="color:#f92672">(</span><span style="color:#ae81ff">2657</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>tpath<span style="color:#f92672">=</span>/cat.jpg<span style="color:#f92672">][</span>bpath<span style="color:#f92672">=</span>cat.jpg<span style="color:#f92672">][</span>save<span style="color:#f92672">=</span>/cat.jpg<span style="color:#f92672">][</span>sseckeypos<span style="color:#f92672">=</span>-1<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:prepare_url<span style="color:#f92672">(</span><span style="color:#ae81ff">4253</span><span style="color:#f92672">)</span>: URL is https://s3.amazonaws.com/mazgi-s3-sse-kms-test-01-bucket-01/cat.jpg
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:prepare_url<span style="color:#f92672">(</span><span style="color:#ae81ff">4285</span><span style="color:#f92672">)</span>: URL changed is https://mazgi-s3-sse-kms-test-01-bucket-01.s3.amazonaws.com/cat.jpg
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:insertV4Headers<span style="color:#f92672">(</span><span style="color:#ae81ff">2400</span><span style="color:#f92672">)</span>: computing signature <span style="color:#f92672">[</span>HEAD<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>/cat.jpg<span style="color:#f92672">]</span> <span style="color:#f92672">[]</span> <span style="color:#f92672">[]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:url_to_host<span style="color:#f92672">(</span><span style="color:#ae81ff">101</span><span style="color:#f92672">)</span>: url is https://s3.amazonaws.com
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:PreHeadRequest<span style="color:#f92672">(</span><span style="color:#ae81ff">2657</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>tpath<span style="color:#f92672">=</span>/cat_plain.jpg<span style="color:#f92672">][</span>bpath<span style="color:#f92672">=</span>cat_plain.jpg<span style="color:#f92672">][</span>save<span style="color:#f92672">=</span>/cat_plain.jpg<span style="color:#f92672">][</span>sseckeypos<span style="color:#f92672">=</span>-1<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:prepare_url<span style="color:#f92672">(</span><span style="color:#ae81ff">4253</span><span style="color:#f92672">)</span>: URL is https://s3.amazonaws.com/mazgi-s3-sse-kms-test-01-bucket-01/cat_plain.jpg
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:prepare_url<span style="color:#f92672">(</span><span style="color:#ae81ff">4285</span><span style="color:#f92672">)</span>: URL changed is https://mazgi-s3-sse-kms-test-01-bucket-01.s3.amazonaws.com/cat_plain.jpg
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:insertV4Headers<span style="color:#f92672">(</span><span style="color:#ae81ff">2400</span><span style="color:#f92672">)</span>: computing signature <span style="color:#f92672">[</span>HEAD<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>/cat_plain.jpg<span style="color:#f92672">]</span> <span style="color:#f92672">[]</span> <span style="color:#f92672">[]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:url_to_host<span style="color:#f92672">(</span><span style="color:#ae81ff">101</span><span style="color:#f92672">)</span>: url is https://s3.amazonaws.com
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:Request<span style="color:#f92672">(</span><span style="color:#ae81ff">3999</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>count<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span><span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:RequestPerform<span style="color:#f92672">(</span><span style="color:#ae81ff">2051</span><span style="color:#f92672">)</span>: HTTP response code <span style="color:#ae81ff">200</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:RequestPerform<span style="color:#f92672">(</span><span style="color:#ae81ff">2051</span><span style="color:#f92672">)</span>: HTTP response code <span style="color:#ae81ff">200</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       cache.cpp:AddStat<span style="color:#f92672">(</span><span style="color:#ae81ff">356</span><span style="color:#f92672">)</span>: add stat cache entry<span style="color:#f92672">[</span>path<span style="color:#f92672">=</span>/cat_plain.jpg<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       cache.cpp:AddStat<span style="color:#f92672">(</span><span style="color:#ae81ff">356</span><span style="color:#f92672">)</span>: add stat cache entry<span style="color:#f92672">[</span>path<span style="color:#f92672">=</span>/cat.jpg<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span> s3fs.cpp:s3fs_getattr<span style="color:#f92672">(</span><span style="color:#ae81ff">841</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>path<span style="color:#f92672">=</span>/cat.jpg<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span> s3fs.cpp:s3fs_getattr<span style="color:#f92672">(</span><span style="color:#ae81ff">841</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>path<span style="color:#f92672">=</span>/cat_plain.jpg<span style="color:#f92672">]</span></code></pre></div>

<p>アップロード前のチェックサムがこれ。</p>

<p><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ shasum -a <span style="color:#ae81ff">1</span> cat.jpg
fb9f3c47ad3d91ced2e62c82f0ae753330351b32  cat.jpg</code></pre></div></p>

<p>mountしたS3バケットから読み取りテスト兼ねてチェックサムを取得してみる。<br />
一致しているので正しく読み取れていることがわかる。</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sha1sum bucket/cat.jpg
fb9f3c47ad3d91ced2e62c82f0ae753330351b32  bucket/cat.jpg</code></pre></div>

<p>ファイル読み取り時のコンソールログ。</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span> s3fs.cpp:s3fs_getattr<span style="color:#f92672">(</span><span style="color:#ae81ff">841</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>path<span style="color:#f92672">=</span>/cat.jpg<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span> s3fs.cpp:s3fs_open<span style="color:#f92672">(</span><span style="color:#ae81ff">2063</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>path<span style="color:#f92672">=</span>/cat.jpg<span style="color:#f92672">][</span>flags<span style="color:#f92672">=</span><span style="color:#ae81ff">32768</span><span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       cache.cpp:DelStat<span style="color:#f92672">(</span><span style="color:#ae81ff">565</span><span style="color:#f92672">)</span>: delete stat cache entry<span style="color:#f92672">[</span>path<span style="color:#f92672">=</span>/cat.jpg<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:HeadRequest<span style="color:#f92672">(</span><span style="color:#ae81ff">2708</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>tpath<span style="color:#f92672">=</span>/cat.jpg<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:PreHeadRequest<span style="color:#f92672">(</span><span style="color:#ae81ff">2657</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>tpath<span style="color:#f92672">=</span>/cat.jpg<span style="color:#f92672">][</span>bpath<span style="color:#f92672">=][</span>save<span style="color:#f92672">=][</span>sseckeypos<span style="color:#f92672">=</span>-1<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:prepare_url<span style="color:#f92672">(</span><span style="color:#ae81ff">4253</span><span style="color:#f92672">)</span>: URL is https://s3.amazonaws.com/mazgi-s3-sse-kms-test-01-bucket-01/cat.jpg
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:prepare_url<span style="color:#f92672">(</span><span style="color:#ae81ff">4285</span><span style="color:#f92672">)</span>: URL changed is https://mazgi-s3-sse-kms-test-01-bucket-01.s3.amazonaws.com/cat.jpg
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:insertV4Headers<span style="color:#f92672">(</span><span style="color:#ae81ff">2400</span><span style="color:#f92672">)</span>: computing signature <span style="color:#f92672">[</span>HEAD<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>/cat.jpg<span style="color:#f92672">]</span> <span style="color:#f92672">[]</span> <span style="color:#f92672">[]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:url_to_host<span style="color:#f92672">(</span><span style="color:#ae81ff">101</span><span style="color:#f92672">)</span>: url is https://s3.amazonaws.com
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:RequestPerform<span style="color:#f92672">(</span><span style="color:#ae81ff">2051</span><span style="color:#f92672">)</span>: HTTP response code <span style="color:#ae81ff">200</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       cache.cpp:AddStat<span style="color:#f92672">(</span><span style="color:#ae81ff">356</span><span style="color:#f92672">)</span>: add stat cache entry<span style="color:#f92672">[</span>path<span style="color:#f92672">=</span>/cat.jpg<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       fdcache.cpp:SetMtime<span style="color:#f92672">(</span><span style="color:#ae81ff">1019</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>path<span style="color:#f92672">=</span>/cat.jpg<span style="color:#f92672">][</span>fd<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span><span style="color:#f92672">][</span>time<span style="color:#f92672">=</span><span style="color:#ae81ff">1517436613</span><span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:GetObjectRequest<span style="color:#f92672">(</span><span style="color:#ae81ff">3043</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>tpath<span style="color:#f92672">=</span>/cat.jpg<span style="color:#f92672">][</span>start<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span><span style="color:#f92672">][</span>size<span style="color:#f92672">=</span><span style="color:#ae81ff">96870</span><span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:PreGetObjectRequest<span style="color:#f92672">(</span><span style="color:#ae81ff">2983</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>tpath<span style="color:#f92672">=</span>/cat.jpg<span style="color:#f92672">][</span>start<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span><span style="color:#f92672">][</span>size<span style="color:#f92672">=</span><span style="color:#ae81ff">96870</span><span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:prepare_url<span style="color:#f92672">(</span><span style="color:#ae81ff">4253</span><span style="color:#f92672">)</span>: URL is https://s3.amazonaws.com/mazgi-s3-sse-kms-test-01-bucket-01/cat.jpg
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:prepare_url<span style="color:#f92672">(</span><span style="color:#ae81ff">4285</span><span style="color:#f92672">)</span>: URL changed is https://mazgi-s3-sse-kms-test-01-bucket-01.s3.amazonaws.com/cat.jpg
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:insertV4Headers<span style="color:#f92672">(</span><span style="color:#ae81ff">2400</span><span style="color:#f92672">)</span>: computing signature <span style="color:#f92672">[</span>GET<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>/cat.jpg<span style="color:#f92672">]</span> <span style="color:#f92672">[]</span> <span style="color:#f92672">[]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:url_to_host<span style="color:#f92672">(</span><span style="color:#ae81ff">101</span><span style="color:#f92672">)</span>: url is https://s3.amazonaws.com
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:GetObjectRequest<span style="color:#f92672">(</span><span style="color:#ae81ff">3058</span><span style="color:#f92672">)</span>: downloading... <span style="color:#f92672">[</span>path<span style="color:#f92672">=</span>/cat.jpg<span style="color:#f92672">][</span>fd<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span><span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:RequestPerform<span style="color:#f92672">(</span><span style="color:#ae81ff">2051</span><span style="color:#f92672">)</span>: HTTP response code <span style="color:#ae81ff">206</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span> s3fs.cpp:s3fs_getattr<span style="color:#f92672">(</span><span style="color:#ae81ff">841</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>path<span style="color:#f92672">=</span>/cat.jpg<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span> s3fs.cpp:s3fs_flush<span style="color:#f92672">(</span><span style="color:#ae81ff">2185</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>path<span style="color:#f92672">=</span>/cat.jpg<span style="color:#f92672">][</span>fd<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span><span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       fdcache.cpp:RowFlush<span style="color:#f92672">(</span><span style="color:#ae81ff">1434</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>tpath<span style="color:#f92672">=][</span>path<span style="color:#f92672">=</span>/cat.jpg<span style="color:#f92672">][</span>fd<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span><span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span> s3fs.cpp:s3fs_release<span style="color:#f92672">(</span><span style="color:#ae81ff">2238</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>path<span style="color:#f92672">=</span>/cat.jpg<span style="color:#f92672">][</span>fd<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span><span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       fdcache.cpp:GetFdEntity<span style="color:#f92672">(</span><span style="color:#ae81ff">1995</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>path<span style="color:#f92672">=</span>/cat.jpg<span style="color:#f92672">][</span>fd<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span><span style="color:#f92672">]</span></code></pre></div>

<p>今度はS3バケットにファイルを書き込んでみる。<br />
適当にファイルを作りチェックサムを取得。</p>

<p><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ head -1 /dev/urandom|od -x &gt; rand.txt
$ sha1sum rand.txt
bb02ee0d5fc5b459ca1978fcc0e53649d144554c  rand.txt</code></pre></div></p>

<p>マウントポイントにコピーする。<br />
コピー後のチェックサムが一致しているので正しくコピーできたことがわかる。</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cp rand.txt bucket/
$ sha1sum bucket/rand.txt
bb02ee0d5fc5b459ca1978fcc0e53649d144554c  bucket/rand.txt</code></pre></div>

<p>書き込み時のコンソールログ。</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span> s3fs.cpp:s3fs_getattr<span style="color:#f92672">(</span><span style="color:#ae81ff">841</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>path<span style="color:#f92672">=</span>/<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span> s3fs.cpp:s3fs_getattr<span style="color:#f92672">(</span><span style="color:#ae81ff">841</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>path<span style="color:#f92672">=</span>/rand.txt<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:HeadRequest<span style="color:#f92672">(</span><span style="color:#ae81ff">2708</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>tpath<span style="color:#f92672">=</span>/rand.txt<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:PreHeadRequest<span style="color:#f92672">(</span><span style="color:#ae81ff">2657</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>tpath<span style="color:#f92672">=</span>/rand.txt<span style="color:#f92672">][</span>bpath<span style="color:#f92672">=][</span>save<span style="color:#f92672">=][</span>sseckeypos<span style="color:#f92672">=</span>-1<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:prepare_url<span style="color:#f92672">(</span><span style="color:#ae81ff">4253</span><span style="color:#f92672">)</span>: URL is https://s3.amazonaws.com/mazgi-s3-sse-kms-test-01-bucket-01/rand.txt
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:prepare_url<span style="color:#f92672">(</span><span style="color:#ae81ff">4285</span><span style="color:#f92672">)</span>: URL changed is https://mazgi-s3-sse-kms-test-01-bucket-01.s3.amazonaws.com/rand.txt
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:insertV4Headers<span style="color:#f92672">(</span><span style="color:#ae81ff">2400</span><span style="color:#f92672">)</span>: computing signature <span style="color:#f92672">[</span>HEAD<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>/rand.txt<span style="color:#f92672">]</span> <span style="color:#f92672">[]</span> <span style="color:#f92672">[]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:url_to_host<span style="color:#f92672">(</span><span style="color:#ae81ff">101</span><span style="color:#f92672">)</span>: url is https://s3.amazonaws.com
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:RequestPerform<span style="color:#f92672">(</span><span style="color:#ae81ff">2073</span><span style="color:#f92672">)</span>: HTTP response code <span style="color:#ae81ff">404</span> was returned, returning ENOENT
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:HeadRequest<span style="color:#f92672">(</span><span style="color:#ae81ff">2708</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>tpath<span style="color:#f92672">=</span>/rand.txt/<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:PreHeadRequest<span style="color:#f92672">(</span><span style="color:#ae81ff">2657</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>tpath<span style="color:#f92672">=</span>/rand.txt/<span style="color:#f92672">][</span>bpath<span style="color:#f92672">=][</span>save<span style="color:#f92672">=][</span>sseckeypos<span style="color:#f92672">=</span>-1<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:prepare_url<span style="color:#f92672">(</span><span style="color:#ae81ff">4253</span><span style="color:#f92672">)</span>: URL is https://s3.amazonaws.com/mazgi-s3-sse-kms-test-01-bucket-01/rand.txt/
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:prepare_url<span style="color:#f92672">(</span><span style="color:#ae81ff">4285</span><span style="color:#f92672">)</span>: URL changed is https://mazgi-s3-sse-kms-test-01-bucket-01.s3.amazonaws.com/rand.txt/
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:insertV4Headers<span style="color:#f92672">(</span><span style="color:#ae81ff">2400</span><span style="color:#f92672">)</span>: computing signature <span style="color:#f92672">[</span>HEAD<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>/rand.txt/<span style="color:#f92672">]</span> <span style="color:#f92672">[]</span> <span style="color:#f92672">[]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:url_to_host<span style="color:#f92672">(</span><span style="color:#ae81ff">101</span><span style="color:#f92672">)</span>: url is https://s3.amazonaws.com
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:RequestPerform<span style="color:#f92672">(</span><span style="color:#ae81ff">2073</span><span style="color:#f92672">)</span>: HTTP response code <span style="color:#ae81ff">404</span> was returned, returning ENOENT
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:HeadRequest<span style="color:#f92672">(</span><span style="color:#ae81ff">2708</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>tpath<span style="color:#f92672">=</span>/rand.txt_$folder$<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:PreHeadRequest<span style="color:#f92672">(</span><span style="color:#ae81ff">2657</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>tpath<span style="color:#f92672">=</span>/rand.txt_$folder$<span style="color:#f92672">][</span>bpath<span style="color:#f92672">=][</span>save<span style="color:#f92672">=][</span>sseckeypos<span style="color:#f92672">=</span>-1<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:prepare_url<span style="color:#f92672">(</span><span style="color:#ae81ff">4253</span><span style="color:#f92672">)</span>: URL is https://s3.amazonaws.com/mazgi-s3-sse-kms-test-01-bucket-01/rand.txt_%24folder%24
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:prepare_url<span style="color:#f92672">(</span><span style="color:#ae81ff">4285</span><span style="color:#f92672">)</span>: URL changed is https://mazgi-s3-sse-kms-test-01-bucket-01.s3.amazonaws.com/rand.txt_%24folder%24
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:insertV4Headers<span style="color:#f92672">(</span><span style="color:#ae81ff">2400</span><span style="color:#f92672">)</span>: computing signature <span style="color:#f92672">[</span>HEAD<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>/rand.txt_$folder$<span style="color:#f92672">]</span> <span style="color:#f92672">[]</span> <span style="color:#f92672">[]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:url_to_host<span style="color:#f92672">(</span><span style="color:#ae81ff">101</span><span style="color:#f92672">)</span>: url is https://s3.amazonaws.com
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:RequestPerform<span style="color:#f92672">(</span><span style="color:#ae81ff">2073</span><span style="color:#f92672">)</span>: HTTP response code <span style="color:#ae81ff">404</span> was returned, returning ENOENT
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>   s3fs.cpp:list_bucket<span style="color:#f92672">(</span><span style="color:#ae81ff">2477</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>path<span style="color:#f92672">=</span>/rand.txt<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:ListBucketRequest<span style="color:#f92672">(</span><span style="color:#ae81ff">3103</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>tpath<span style="color:#f92672">=</span>/rand.txt<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:prepare_url<span style="color:#f92672">(</span><span style="color:#ae81ff">4253</span><span style="color:#f92672">)</span>: URL is https://s3.amazonaws.com/mazgi-s3-sse-kms-test-01-bucket-01?delimiter<span style="color:#f92672">=</span>/&amp;max-keys<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>&amp;prefix<span style="color:#f92672">=</span>rand.txt/
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:prepare_url<span style="color:#f92672">(</span><span style="color:#ae81ff">4285</span><span style="color:#f92672">)</span>: URL changed is https://mazgi-s3-sse-kms-test-01-bucket-01.s3.amazonaws.com?delimiter<span style="color:#f92672">=</span>/&amp;max-keys<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>&amp;prefix<span style="color:#f92672">=</span>rand.txt/
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:insertV4Headers<span style="color:#f92672">(</span><span style="color:#ae81ff">2400</span><span style="color:#f92672">)</span>: computing signature <span style="color:#f92672">[</span>GET<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>/<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>delimiter<span style="color:#f92672">=</span>/&amp;max-keys<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>&amp;prefix<span style="color:#f92672">=</span>rand.txt/<span style="color:#f92672">]</span> <span style="color:#f92672">[]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:url_to_host<span style="color:#f92672">(</span><span style="color:#ae81ff">101</span><span style="color:#f92672">)</span>: url is https://s3.amazonaws.com
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:RequestPerform<span style="color:#f92672">(</span><span style="color:#ae81ff">2051</span><span style="color:#f92672">)</span>: HTTP response code <span style="color:#ae81ff">200</span>
<span style="color:#f92672">[</span>WAN<span style="color:#f92672">]</span> s3fs.cpp:append_objects_from_xml_ex<span style="color:#f92672">(</span><span style="color:#ae81ff">2575</span><span style="color:#f92672">)</span>: contents_xp-&gt;nodesetval is empty.
<span style="color:#f92672">[</span>WAN<span style="color:#f92672">]</span> s3fs.cpp:append_objects_from_xml_ex<span style="color:#f92672">(</span><span style="color:#ae81ff">2575</span><span style="color:#f92672">)</span>: contents_xp-&gt;nodesetval is empty.
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span> s3fs.cpp:s3fs_getattr<span style="color:#f92672">(</span><span style="color:#ae81ff">841</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>path<span style="color:#f92672">=</span>/rand.txt<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:HeadRequest<span style="color:#f92672">(</span><span style="color:#ae81ff">2708</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>tpath<span style="color:#f92672">=</span>/rand.txt<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:PreHeadRequest<span style="color:#f92672">(</span><span style="color:#ae81ff">2657</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>tpath<span style="color:#f92672">=</span>/rand.txt<span style="color:#f92672">][</span>bpath<span style="color:#f92672">=][</span>save<span style="color:#f92672">=][</span>sseckeypos<span style="color:#f92672">=</span>-1<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:prepare_url<span style="color:#f92672">(</span><span style="color:#ae81ff">4253</span><span style="color:#f92672">)</span>: URL is https://s3.amazonaws.com/mazgi-s3-sse-kms-test-01-bucket-01/rand.txt
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:prepare_url<span style="color:#f92672">(</span><span style="color:#ae81ff">4285</span><span style="color:#f92672">)</span>: URL changed is https://mazgi-s3-sse-kms-test-01-bucket-01.s3.amazonaws.com/rand.txt
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:insertV4Headers<span style="color:#f92672">(</span><span style="color:#ae81ff">2400</span><span style="color:#f92672">)</span>: computing signature <span style="color:#f92672">[</span>HEAD<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>/rand.txt<span style="color:#f92672">]</span> <span style="color:#f92672">[]</span> <span style="color:#f92672">[]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:url_to_host<span style="color:#f92672">(</span><span style="color:#ae81ff">101</span><span style="color:#f92672">)</span>: url is https://s3.amazonaws.com
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:RequestPerform<span style="color:#f92672">(</span><span style="color:#ae81ff">2073</span><span style="color:#f92672">)</span>: HTTP response code <span style="color:#ae81ff">404</span> was returned, returning ENOENT
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:HeadRequest<span style="color:#f92672">(</span><span style="color:#ae81ff">2708</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>tpath<span style="color:#f92672">=</span>/rand.txt/<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:PreHeadRequest<span style="color:#f92672">(</span><span style="color:#ae81ff">2657</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>tpath<span style="color:#f92672">=</span>/rand.txt/<span style="color:#f92672">][</span>bpath<span style="color:#f92672">=][</span>save<span style="color:#f92672">=][</span>sseckeypos<span style="color:#f92672">=</span>-1<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:prepare_url<span style="color:#f92672">(</span><span style="color:#ae81ff">4253</span><span style="color:#f92672">)</span>: URL is https://s3.amazonaws.com/mazgi-s3-sse-kms-test-01-bucket-01/rand.txt/
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:prepare_url<span style="color:#f92672">(</span><span style="color:#ae81ff">4285</span><span style="color:#f92672">)</span>: URL changed is https://mazgi-s3-sse-kms-test-01-bucket-01.s3.amazonaws.com/rand.txt/
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:insertV4Headers<span style="color:#f92672">(</span><span style="color:#ae81ff">2400</span><span style="color:#f92672">)</span>: computing signature <span style="color:#f92672">[</span>HEAD<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>/rand.txt/<span style="color:#f92672">]</span> <span style="color:#f92672">[]</span> <span style="color:#f92672">[]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:url_to_host<span style="color:#f92672">(</span><span style="color:#ae81ff">101</span><span style="color:#f92672">)</span>: url is https://s3.amazonaws.com
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:RequestPerform<span style="color:#f92672">(</span><span style="color:#ae81ff">2073</span><span style="color:#f92672">)</span>: HTTP response code <span style="color:#ae81ff">404</span> was returned, returning ENOENT
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:HeadRequest<span style="color:#f92672">(</span><span style="color:#ae81ff">2708</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>tpath<span style="color:#f92672">=</span>/rand.txt_$folder$<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:PreHeadRequest<span style="color:#f92672">(</span><span style="color:#ae81ff">2657</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>tpath<span style="color:#f92672">=</span>/rand.txt_$folder$<span style="color:#f92672">][</span>bpath<span style="color:#f92672">=][</span>save<span style="color:#f92672">=][</span>sseckeypos<span style="color:#f92672">=</span>-1<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:prepare_url<span style="color:#f92672">(</span><span style="color:#ae81ff">4253</span><span style="color:#f92672">)</span>: URL is https://s3.amazonaws.com/mazgi-s3-sse-kms-test-01-bucket-01/rand.txt_%24folder%24
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:prepare_url<span style="color:#f92672">(</span><span style="color:#ae81ff">4285</span><span style="color:#f92672">)</span>: URL changed is https://mazgi-s3-sse-kms-test-01-bucket-01.s3.amazonaws.com/rand.txt_%24folder%24
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:insertV4Headers<span style="color:#f92672">(</span><span style="color:#ae81ff">2400</span><span style="color:#f92672">)</span>: computing signature <span style="color:#f92672">[</span>HEAD<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>/rand.txt_$folder$<span style="color:#f92672">]</span> <span style="color:#f92672">[]</span> <span style="color:#f92672">[]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:url_to_host<span style="color:#f92672">(</span><span style="color:#ae81ff">101</span><span style="color:#f92672">)</span>: url is https://s3.amazonaws.com
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:RequestPerform<span style="color:#f92672">(</span><span style="color:#ae81ff">2073</span><span style="color:#f92672">)</span>: HTTP response code <span style="color:#ae81ff">404</span> was returned, returning ENOENT
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>   s3fs.cpp:list_bucket<span style="color:#f92672">(</span><span style="color:#ae81ff">2477</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>path<span style="color:#f92672">=</span>/rand.txt<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:ListBucketRequest<span style="color:#f92672">(</span><span style="color:#ae81ff">3103</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>tpath<span style="color:#f92672">=</span>/rand.txt<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:prepare_url<span style="color:#f92672">(</span><span style="color:#ae81ff">4253</span><span style="color:#f92672">)</span>: URL is https://s3.amazonaws.com/mazgi-s3-sse-kms-test-01-bucket-01?delimiter<span style="color:#f92672">=</span>/&amp;max-keys<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>&amp;prefix<span style="color:#f92672">=</span>rand.txt/
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:prepare_url<span style="color:#f92672">(</span><span style="color:#ae81ff">4285</span><span style="color:#f92672">)</span>: URL changed is https://mazgi-s3-sse-kms-test-01-bucket-01.s3.amazonaws.com?delimiter<span style="color:#f92672">=</span>/&amp;max-keys<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>&amp;prefix<span style="color:#f92672">=</span>rand.txt/
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:insertV4Headers<span style="color:#f92672">(</span><span style="color:#ae81ff">2400</span><span style="color:#f92672">)</span>: computing signature <span style="color:#f92672">[</span>GET<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>/<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>delimiter<span style="color:#f92672">=</span>/&amp;max-keys<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>&amp;prefix<span style="color:#f92672">=</span>rand.txt/<span style="color:#f92672">]</span> <span style="color:#f92672">[]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:url_to_host<span style="color:#f92672">(</span><span style="color:#ae81ff">101</span><span style="color:#f92672">)</span>: url is https://s3.amazonaws.com
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:RequestPerform<span style="color:#f92672">(</span><span style="color:#ae81ff">2051</span><span style="color:#f92672">)</span>: HTTP response code <span style="color:#ae81ff">200</span>
<span style="color:#f92672">[</span>WAN<span style="color:#f92672">]</span> s3fs.cpp:append_objects_from_xml_ex<span style="color:#f92672">(</span><span style="color:#ae81ff">2575</span><span style="color:#f92672">)</span>: contents_xp-&gt;nodesetval is empty.
<span style="color:#f92672">[</span>WAN<span style="color:#f92672">]</span> s3fs.cpp:append_objects_from_xml_ex<span style="color:#f92672">(</span><span style="color:#ae81ff">2575</span><span style="color:#f92672">)</span>: contents_xp-&gt;nodesetval is empty.
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span> s3fs.cpp:s3fs_create<span style="color:#f92672">(</span><span style="color:#ae81ff">999</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>path<span style="color:#f92672">=</span>/rand.txt<span style="color:#f92672">][</span>mode<span style="color:#f92672">=</span><span style="color:#ae81ff">100664</span><span style="color:#f92672">][</span>flags<span style="color:#f92672">=</span><span style="color:#ae81ff">32961</span><span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:HeadRequest<span style="color:#f92672">(</span><span style="color:#ae81ff">2708</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>tpath<span style="color:#f92672">=</span>/rand.txt<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:PreHeadRequest<span style="color:#f92672">(</span><span style="color:#ae81ff">2657</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>tpath<span style="color:#f92672">=</span>/rand.txt<span style="color:#f92672">][</span>bpath<span style="color:#f92672">=][</span>save<span style="color:#f92672">=][</span>sseckeypos<span style="color:#f92672">=</span>-1<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:prepare_url<span style="color:#f92672">(</span><span style="color:#ae81ff">4253</span><span style="color:#f92672">)</span>: URL is https://s3.amazonaws.com/mazgi-s3-sse-kms-test-01-bucket-01/rand.txt
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:prepare_url<span style="color:#f92672">(</span><span style="color:#ae81ff">4285</span><span style="color:#f92672">)</span>: URL changed is https://mazgi-s3-sse-kms-test-01-bucket-01.s3.amazonaws.com/rand.txt
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:insertV4Headers<span style="color:#f92672">(</span><span style="color:#ae81ff">2400</span><span style="color:#f92672">)</span>: computing signature <span style="color:#f92672">[</span>HEAD<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>/rand.txt<span style="color:#f92672">]</span> <span style="color:#f92672">[]</span> <span style="color:#f92672">[]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:url_to_host<span style="color:#f92672">(</span><span style="color:#ae81ff">101</span><span style="color:#f92672">)</span>: url is https://s3.amazonaws.com
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:RequestPerform<span style="color:#f92672">(</span><span style="color:#ae81ff">2073</span><span style="color:#f92672">)</span>: HTTP response code <span style="color:#ae81ff">404</span> was returned, returning ENOENT
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:HeadRequest<span style="color:#f92672">(</span><span style="color:#ae81ff">2708</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>tpath<span style="color:#f92672">=</span>/rand.txt/<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:PreHeadRequest<span style="color:#f92672">(</span><span style="color:#ae81ff">2657</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>tpath<span style="color:#f92672">=</span>/rand.txt/<span style="color:#f92672">][</span>bpath<span style="color:#f92672">=][</span>save<span style="color:#f92672">=][</span>sseckeypos<span style="color:#f92672">=</span>-1<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:prepare_url<span style="color:#f92672">(</span><span style="color:#ae81ff">4253</span><span style="color:#f92672">)</span>: URL is https://s3.amazonaws.com/mazgi-s3-sse-kms-test-01-bucket-01/rand.txt/
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:prepare_url<span style="color:#f92672">(</span><span style="color:#ae81ff">4285</span><span style="color:#f92672">)</span>: URL changed is https://mazgi-s3-sse-kms-test-01-bucket-01.s3.amazonaws.com/rand.txt/
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:insertV4Headers<span style="color:#f92672">(</span><span style="color:#ae81ff">2400</span><span style="color:#f92672">)</span>: computing signature <span style="color:#f92672">[</span>HEAD<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>/rand.txt/<span style="color:#f92672">]</span> <span style="color:#f92672">[]</span> <span style="color:#f92672">[]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:url_to_host<span style="color:#f92672">(</span><span style="color:#ae81ff">101</span><span style="color:#f92672">)</span>: url is https://s3.amazonaws.com
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:RequestPerform<span style="color:#f92672">(</span><span style="color:#ae81ff">2073</span><span style="color:#f92672">)</span>: HTTP response code <span style="color:#ae81ff">404</span> was returned, returning ENOENT
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:HeadRequest<span style="color:#f92672">(</span><span style="color:#ae81ff">2708</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>tpath<span style="color:#f92672">=</span>/rand.txt_$folder$<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:PreHeadRequest<span style="color:#f92672">(</span><span style="color:#ae81ff">2657</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>tpath<span style="color:#f92672">=</span>/rand.txt_$folder$<span style="color:#f92672">][</span>bpath<span style="color:#f92672">=][</span>save<span style="color:#f92672">=][</span>sseckeypos<span style="color:#f92672">=</span>-1<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:prepare_url<span style="color:#f92672">(</span><span style="color:#ae81ff">4253</span><span style="color:#f92672">)</span>: URL is https://s3.amazonaws.com/mazgi-s3-sse-kms-test-01-bucket-01/rand.txt_%24folder%24
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:prepare_url<span style="color:#f92672">(</span><span style="color:#ae81ff">4285</span><span style="color:#f92672">)</span>: URL changed is https://mazgi-s3-sse-kms-test-01-bucket-01.s3.amazonaws.com/rand.txt_%24folder%24
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:insertV4Headers<span style="color:#f92672">(</span><span style="color:#ae81ff">2400</span><span style="color:#f92672">)</span>: computing signature <span style="color:#f92672">[</span>HEAD<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>/rand.txt_$folder$<span style="color:#f92672">]</span> <span style="color:#f92672">[]</span> <span style="color:#f92672">[]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:url_to_host<span style="color:#f92672">(</span><span style="color:#ae81ff">101</span><span style="color:#f92672">)</span>: url is https://s3.amazonaws.com
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:RequestPerform<span style="color:#f92672">(</span><span style="color:#ae81ff">2073</span><span style="color:#f92672">)</span>: HTTP response code <span style="color:#ae81ff">404</span> was returned, returning ENOENT
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>   s3fs.cpp:list_bucket<span style="color:#f92672">(</span><span style="color:#ae81ff">2477</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>path<span style="color:#f92672">=</span>/rand.txt<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:ListBucketRequest<span style="color:#f92672">(</span><span style="color:#ae81ff">3103</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>tpath<span style="color:#f92672">=</span>/rand.txt<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:prepare_url<span style="color:#f92672">(</span><span style="color:#ae81ff">4253</span><span style="color:#f92672">)</span>: URL is https://s3.amazonaws.com/mazgi-s3-sse-kms-test-01-bucket-01?delimiter<span style="color:#f92672">=</span>/&amp;max-keys<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>&amp;prefix<span style="color:#f92672">=</span>rand.txt/
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:prepare_url<span style="color:#f92672">(</span><span style="color:#ae81ff">4285</span><span style="color:#f92672">)</span>: URL changed is https://mazgi-s3-sse-kms-test-01-bucket-01.s3.amazonaws.com?delimiter<span style="color:#f92672">=</span>/&amp;max-keys<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>&amp;prefix<span style="color:#f92672">=</span>rand.txt/
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:insertV4Headers<span style="color:#f92672">(</span><span style="color:#ae81ff">2400</span><span style="color:#f92672">)</span>: computing signature <span style="color:#f92672">[</span>GET<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>/<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>delimiter<span style="color:#f92672">=</span>/&amp;max-keys<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>&amp;prefix<span style="color:#f92672">=</span>rand.txt/<span style="color:#f92672">]</span> <span style="color:#f92672">[]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:url_to_host<span style="color:#f92672">(</span><span style="color:#ae81ff">101</span><span style="color:#f92672">)</span>: url is https://s3.amazonaws.com
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:RequestPerform<span style="color:#f92672">(</span><span style="color:#ae81ff">2051</span><span style="color:#f92672">)</span>: HTTP response code <span style="color:#ae81ff">200</span>
<span style="color:#f92672">[</span>WAN<span style="color:#f92672">]</span> s3fs.cpp:append_objects_from_xml_ex<span style="color:#f92672">(</span><span style="color:#ae81ff">2575</span><span style="color:#f92672">)</span>: contents_xp-&gt;nodesetval is empty.
<span style="color:#f92672">[</span>WAN<span style="color:#f92672">]</span> s3fs.cpp:append_objects_from_xml_ex<span style="color:#f92672">(</span><span style="color:#ae81ff">2575</span><span style="color:#f92672">)</span>: contents_xp-&gt;nodesetval is empty.
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>     s3fs.cpp:create_file_object<span style="color:#f92672">(</span><span style="color:#ae81ff">960</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>path<span style="color:#f92672">=</span>/rand.txt<span style="color:#f92672">][</span>mode<span style="color:#f92672">=</span><span style="color:#ae81ff">100664</span><span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:PutRequest<span style="color:#f92672">(</span><span style="color:#ae81ff">2872</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>tpath<span style="color:#f92672">=</span>/rand.txt<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:PutRequest<span style="color:#f92672">(</span><span style="color:#ae81ff">2889</span><span style="color:#f92672">)</span>: create zero byte file object.
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:prepare_url<span style="color:#f92672">(</span><span style="color:#ae81ff">4253</span><span style="color:#f92672">)</span>: URL is https://s3.amazonaws.com/mazgi-s3-sse-kms-test-01-bucket-01/rand.txt
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:prepare_url<span style="color:#f92672">(</span><span style="color:#ae81ff">4285</span><span style="color:#f92672">)</span>: URL changed is https://mazgi-s3-sse-kms-test-01-bucket-01.s3.amazonaws.com/rand.txt
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:insertV4Headers<span style="color:#f92672">(</span><span style="color:#ae81ff">2400</span><span style="color:#f92672">)</span>: computing signature <span style="color:#f92672">[</span>PUT<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>/rand.txt<span style="color:#f92672">]</span> <span style="color:#f92672">[]</span> <span style="color:#f92672">[]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:url_to_host<span style="color:#f92672">(</span><span style="color:#ae81ff">101</span><span style="color:#f92672">)</span>: url is https://s3.amazonaws.com
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:PutRequest<span style="color:#f92672">(</span><span style="color:#ae81ff">2969</span><span style="color:#f92672">)</span>: uploading... <span style="color:#f92672">[</span>path<span style="color:#f92672">=</span>/rand.txt<span style="color:#f92672">][</span>fd<span style="color:#f92672">=</span>-1<span style="color:#f92672">][</span>size<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span><span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:RequestPerform<span style="color:#f92672">(</span><span style="color:#ae81ff">2051</span><span style="color:#f92672">)</span>: HTTP response code <span style="color:#ae81ff">200</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       cache.cpp:DelStat<span style="color:#f92672">(</span><span style="color:#ae81ff">565</span><span style="color:#f92672">)</span>: delete stat cache entry<span style="color:#f92672">[</span>path<span style="color:#f92672">=</span>/rand.txt<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:HeadRequest<span style="color:#f92672">(</span><span style="color:#ae81ff">2708</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>tpath<span style="color:#f92672">=</span>/rand.txt<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:PreHeadRequest<span style="color:#f92672">(</span><span style="color:#ae81ff">2657</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>tpath<span style="color:#f92672">=</span>/rand.txt<span style="color:#f92672">][</span>bpath<span style="color:#f92672">=][</span>save<span style="color:#f92672">=][</span>sseckeypos<span style="color:#f92672">=</span>-1<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:prepare_url<span style="color:#f92672">(</span><span style="color:#ae81ff">4253</span><span style="color:#f92672">)</span>: URL is https://s3.amazonaws.com/mazgi-s3-sse-kms-test-01-bucket-01/rand.txt
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:prepare_url<span style="color:#f92672">(</span><span style="color:#ae81ff">4285</span><span style="color:#f92672">)</span>: URL changed is https://mazgi-s3-sse-kms-test-01-bucket-01.s3.amazonaws.com/rand.txt
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:insertV4Headers<span style="color:#f92672">(</span><span style="color:#ae81ff">2400</span><span style="color:#f92672">)</span>: computing signature <span style="color:#f92672">[</span>HEAD<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>/rand.txt<span style="color:#f92672">]</span> <span style="color:#f92672">[]</span> <span style="color:#f92672">[]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:url_to_host<span style="color:#f92672">(</span><span style="color:#ae81ff">101</span><span style="color:#f92672">)</span>: url is https://s3.amazonaws.com
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:RequestPerform<span style="color:#f92672">(</span><span style="color:#ae81ff">2051</span><span style="color:#f92672">)</span>: HTTP response code <span style="color:#ae81ff">200</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       cache.cpp:AddStat<span style="color:#f92672">(</span><span style="color:#ae81ff">356</span><span style="color:#f92672">)</span>: add stat cache entry<span style="color:#f92672">[</span>path<span style="color:#f92672">=</span>/rand.txt<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span> s3fs.cpp:s3fs_getattr<span style="color:#f92672">(</span><span style="color:#ae81ff">841</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>path<span style="color:#f92672">=</span>/rand.txt<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span> s3fs.cpp:s3fs_flush<span style="color:#f92672">(</span><span style="color:#ae81ff">2185</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>path<span style="color:#f92672">=</span>/rand.txt<span style="color:#f92672">][</span>fd<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span><span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       fdcache.cpp:RowFlush<span style="color:#f92672">(</span><span style="color:#ae81ff">1434</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>tpath<span style="color:#f92672">=][</span>path<span style="color:#f92672">=</span>/rand.txt<span style="color:#f92672">][</span>fd<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span><span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:PutRequest<span style="color:#f92672">(</span><span style="color:#ae81ff">2872</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>tpath<span style="color:#f92672">=</span>/rand.txt<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:prepare_url<span style="color:#f92672">(</span><span style="color:#ae81ff">4253</span><span style="color:#f92672">)</span>: URL is https://s3.amazonaws.com/mazgi-s3-sse-kms-test-01-bucket-01/rand.txt
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:prepare_url<span style="color:#f92672">(</span><span style="color:#ae81ff">4285</span><span style="color:#f92672">)</span>: URL changed is https://mazgi-s3-sse-kms-test-01-bucket-01.s3.amazonaws.com/rand.txt
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:insertV4Headers<span style="color:#f92672">(</span><span style="color:#ae81ff">2400</span><span style="color:#f92672">)</span>: computing signature <span style="color:#f92672">[</span>PUT<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>/rand.txt<span style="color:#f92672">]</span> <span style="color:#f92672">[]</span> <span style="color:#f92672">[</span>2a5b392dff6867a115948ff04fbec762a6f007cffebf40544c62308ec9eab099<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:url_to_host<span style="color:#f92672">(</span><span style="color:#ae81ff">101</span><span style="color:#f92672">)</span>: url is https://s3.amazonaws.com
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:PutRequest<span style="color:#f92672">(</span><span style="color:#ae81ff">2969</span><span style="color:#f92672">)</span>: uploading... <span style="color:#f92672">[</span>path<span style="color:#f92672">=</span>/rand.txt<span style="color:#f92672">][</span>fd<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span><span style="color:#f92672">][</span>size<span style="color:#f92672">=</span><span style="color:#ae81ff">996</span><span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:RequestPerform<span style="color:#f92672">(</span><span style="color:#ae81ff">2051</span><span style="color:#f92672">)</span>: HTTP response code <span style="color:#ae81ff">200</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span> s3fs.cpp:s3fs_release<span style="color:#f92672">(</span><span style="color:#ae81ff">2238</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>path<span style="color:#f92672">=</span>/rand.txt<span style="color:#f92672">][</span>fd<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span><span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       cache.cpp:DelStat<span style="color:#f92672">(</span><span style="color:#ae81ff">565</span><span style="color:#f92672">)</span>: delete stat cache entry<span style="color:#f92672">[</span>path<span style="color:#f92672">=</span>/rand.txt<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       fdcache.cpp:GetFdEntity<span style="color:#f92672">(</span><span style="color:#ae81ff">1995</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>path<span style="color:#f92672">=</span>/rand.txt<span style="color:#f92672">][</span>fd<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span><span style="color:#f92672">]</span></code></pre></div>

<p>こちらはチェックサム取得時のコンソールログ。</p>

<p><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span> s3fs.cpp:s3fs_getattr<span style="color:#f92672">(</span><span style="color:#ae81ff">841</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>path<span style="color:#f92672">=</span>/rand.txt<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:HeadRequest<span style="color:#f92672">(</span><span style="color:#ae81ff">2708</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>tpath<span style="color:#f92672">=</span>/rand.txt<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:PreHeadRequest<span style="color:#f92672">(</span><span style="color:#ae81ff">2657</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>tpath<span style="color:#f92672">=</span>/rand.txt<span style="color:#f92672">][</span>bpath<span style="color:#f92672">=][</span>save<span style="color:#f92672">=][</span>sseckeypos<span style="color:#f92672">=</span>-1<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:prepare_url<span style="color:#f92672">(</span><span style="color:#ae81ff">4253</span><span style="color:#f92672">)</span>: URL is https://s3.amazonaws.com/mazgi-s3-sse-kms-test-01-bucket-01/rand.txt
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:prepare_url<span style="color:#f92672">(</span><span style="color:#ae81ff">4285</span><span style="color:#f92672">)</span>: URL changed is https://mazgi-s3-sse-kms-test-01-bucket-01.s3.amazonaws.com/rand.txt
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:insertV4Headers<span style="color:#f92672">(</span><span style="color:#ae81ff">2400</span><span style="color:#f92672">)</span>: computing signature <span style="color:#f92672">[</span>HEAD<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>/rand.txt<span style="color:#f92672">]</span> <span style="color:#f92672">[]</span> <span style="color:#f92672">[]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:url_to_host<span style="color:#f92672">(</span><span style="color:#ae81ff">101</span><span style="color:#f92672">)</span>: url is https://s3.amazonaws.com
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:RequestPerform<span style="color:#f92672">(</span><span style="color:#ae81ff">2051</span><span style="color:#f92672">)</span>: HTTP response code <span style="color:#ae81ff">200</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       cache.cpp:AddStat<span style="color:#f92672">(</span><span style="color:#ae81ff">356</span><span style="color:#f92672">)</span>: add stat cache entry<span style="color:#f92672">[</span>path<span style="color:#f92672">=</span>/rand.txt<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span> s3fs.cpp:s3fs_open<span style="color:#f92672">(</span><span style="color:#ae81ff">2063</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>path<span style="color:#f92672">=</span>/rand.txt<span style="color:#f92672">][</span>flags<span style="color:#f92672">=</span><span style="color:#ae81ff">32768</span><span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       cache.cpp:DelStat<span style="color:#f92672">(</span><span style="color:#ae81ff">565</span><span style="color:#f92672">)</span>: delete stat cache entry<span style="color:#f92672">[</span>path<span style="color:#f92672">=</span>/rand.txt<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:HeadRequest<span style="color:#f92672">(</span><span style="color:#ae81ff">2708</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>tpath<span style="color:#f92672">=</span>/rand.txt<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:PreHeadRequest<span style="color:#f92672">(</span><span style="color:#ae81ff">2657</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>tpath<span style="color:#f92672">=</span>/rand.txt<span style="color:#f92672">][</span>bpath<span style="color:#f92672">=][</span>save<span style="color:#f92672">=][</span>sseckeypos<span style="color:#f92672">=</span>-1<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:prepare_url<span style="color:#f92672">(</span><span style="color:#ae81ff">4253</span><span style="color:#f92672">)</span>: URL is https://s3.amazonaws.com/mazgi-s3-sse-kms-test-01-bucket-01/rand.txt
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:prepare_url<span style="color:#f92672">(</span><span style="color:#ae81ff">4285</span><span style="color:#f92672">)</span>: URL changed is https://mazgi-s3-sse-kms-test-01-bucket-01.s3.amazonaws.com/rand.txt
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:insertV4Headers<span style="color:#f92672">(</span><span style="color:#ae81ff">2400</span><span style="color:#f92672">)</span>: computing signature <span style="color:#f92672">[</span>HEAD<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>/rand.txt<span style="color:#f92672">]</span> <span style="color:#f92672">[]</span> <span style="color:#f92672">[]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:url_to_host<span style="color:#f92672">(</span><span style="color:#ae81ff">101</span><span style="color:#f92672">)</span>: url is https://s3.amazonaws.com
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:RequestPerform<span style="color:#f92672">(</span><span style="color:#ae81ff">2051</span><span style="color:#f92672">)</span>: HTTP response code <span style="color:#ae81ff">200</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       cache.cpp:AddStat<span style="color:#f92672">(</span><span style="color:#ae81ff">356</span><span style="color:#f92672">)</span>: add stat cache entry<span style="color:#f92672">[</span>path<span style="color:#f92672">=</span>/rand.txt<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       fdcache.cpp:SetMtime<span style="color:#f92672">(</span><span style="color:#ae81ff">1019</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>path<span style="color:#f92672">=</span>/rand.txt<span style="color:#f92672">][</span>fd<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span><span style="color:#f92672">][</span>time<span style="color:#f92672">=</span><span style="color:#ae81ff">1517862525</span><span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:GetObjectRequest<span style="color:#f92672">(</span><span style="color:#ae81ff">3043</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>tpath<span style="color:#f92672">=</span>/rand.txt<span style="color:#f92672">][</span>start<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span><span style="color:#f92672">][</span>size<span style="color:#f92672">=</span><span style="color:#ae81ff">996</span><span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:PreGetObjectRequest<span style="color:#f92672">(</span><span style="color:#ae81ff">2983</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>tpath<span style="color:#f92672">=</span>/rand.txt<span style="color:#f92672">][</span>start<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span><span style="color:#f92672">][</span>size<span style="color:#f92672">=</span><span style="color:#ae81ff">996</span><span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:prepare_url<span style="color:#f92672">(</span><span style="color:#ae81ff">4253</span><span style="color:#f92672">)</span>: URL is https://s3.amazonaws.com/mazgi-s3-sse-kms-test-01-bucket-01/rand.txt
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:prepare_url<span style="color:#f92672">(</span><span style="color:#ae81ff">4285</span><span style="color:#f92672">)</span>: URL changed is https://mazgi-s3-sse-kms-test-01-bucket-01.s3.amazonaws.com/rand.txt
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:insertV4Headers<span style="color:#f92672">(</span><span style="color:#ae81ff">2400</span><span style="color:#f92672">)</span>: computing signature <span style="color:#f92672">[</span>GET<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>/rand.txt<span style="color:#f92672">]</span> <span style="color:#f92672">[]</span> <span style="color:#f92672">[]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:url_to_host<span style="color:#f92672">(</span><span style="color:#ae81ff">101</span><span style="color:#f92672">)</span>: url is https://s3.amazonaws.com
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:GetObjectRequest<span style="color:#f92672">(</span><span style="color:#ae81ff">3058</span><span style="color:#f92672">)</span>: downloading... <span style="color:#f92672">[</span>path<span style="color:#f92672">=</span>/rand.txt<span style="color:#f92672">][</span>fd<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span><span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       curl.cpp:RequestPerform<span style="color:#f92672">(</span><span style="color:#ae81ff">2051</span><span style="color:#f92672">)</span>: HTTP response code <span style="color:#ae81ff">206</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span> s3fs.cpp:s3fs_getattr<span style="color:#f92672">(</span><span style="color:#ae81ff">841</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>path<span style="color:#f92672">=</span>/rand.txt<span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span> s3fs.cpp:s3fs_flush<span style="color:#f92672">(</span><span style="color:#ae81ff">2185</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>path<span style="color:#f92672">=</span>/rand.txt<span style="color:#f92672">][</span>fd<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span><span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       fdcache.cpp:RowFlush<span style="color:#f92672">(</span><span style="color:#ae81ff">1434</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>tpath<span style="color:#f92672">=][</span>path<span style="color:#f92672">=</span>/rand.txt<span style="color:#f92672">][</span>fd<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span><span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span> s3fs.cpp:s3fs_release<span style="color:#f92672">(</span><span style="color:#ae81ff">2238</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>path<span style="color:#f92672">=</span>/rand.txt<span style="color:#f92672">][</span>fd<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span><span style="color:#f92672">]</span>
<span style="color:#f92672">[</span>INF<span style="color:#f92672">]</span>       fdcache.cpp:GetFdEntity<span style="color:#f92672">(</span><span style="color:#ae81ff">1995</span><span style="color:#f92672">)</span>: <span style="color:#f92672">[</span>path<span style="color:#f92672">=</span>/rand.txt<span style="color:#f92672">][</span>fd<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span><span style="color:#f92672">]</span></code></pre></div></p>

<p>以上、ちょっとハマったができてみるとあっさり暗号化したS3バケットが扱えた。</p>

<p>で、「これをprovisioningするの時間がないなー」とか思ってたら斜め後ろのベテランエンジニアがサクッとitamaeのrecipeにしてくれた。感謝。</p>

    </article>
    
    <hr/>
    
    
    <article>
      <div class="row">
        <h1><a href="/posts/2018.02/s3&#43;cloudfront-website-with-terraform-and-circleci/">S3&#43;CloudFrontをTerraformで設定してCircleCIで更新する</a></h1>
      </div>
      

<p>「TerraformでS3+CloudFront+SSL/TLS証明書 w/ ACMを設定してHugoで作ったstaticなWebサイトをCircleCIで自動deployする」やつができた。</p>

<h1 id="できたもの">できたもの</h1>

<p>普通のいかにも<a href="https://gohugo.io/">Hugo</a>で作ったWebサイトができた。<br />
もう2018年なので手オペなどせずInfrastructure as Codeで構築かつCIでコンテンツdeployです。<br />
中身はまだない。<br />
きっと酒とメシについての何かが書かれるのでしょう。</p>


<figure>
    <a href="https://sakemeshi.love/">
        <img src="/posts/2018.02/s3&#43;cloudfront-website-with-terraform-and-circleci/0001.png" />
    </a>
    
</figure>


<p>これはそもそも<a href="https://denatechstudio.connpass.com/event/72710/">先日開催したハッカソン</a>でやろうとして途中までしか進められなかったので、その補習も兼ねてます。<br />
なお次回ハッカソンはGoです！</p>

<p><a href="https://denatechstudio.connpass.com/event/75706/">DeNA Techathon: 著者と学ぶ「Goならわかるシステムプログラミング」黙々会 - connpass</a></p>

<h2 id="構成">構成</h2>

<p>図を描く気力がなかったのでテキストで。</p>

<h3 id="インフラ構築編">インフラ構築編</h3>

<p><a href="https://www.terraform.io/">Terraform</a>で以下を行なっている。</p>

<ol>
<li>Route 53にドメインのゾーン情報を登録する</li>
<li>コンテンツ更新用のIAMグループとIAMユーザーを払い出す</li>
<li>コンテンツ格納用のS3バケットを作る</li>
<li>ACMでSSL/TLS証明書を発行する</li>
<li>CloudFront distributionを設定する(ACMの証明書使いたいので)</li>
<li>CloudFront distributionをRoute 53に登録する</li>
</ol>

<h3 id="コンテンツ更新編">コンテンツ更新編</h3>

<p>GitHubへのpushをトリガーに<a href="https://circleci.com/">CircleCI</a>で以下を行なっている。</p>

<ol>
<li>HugoでstaticなWebコンテンツ生成する</li>
<li>生成したWebコンテンツをS3に同期する</li>
<li>CloudFrontのキャッシュをクリアする</li>
</ol>

<h3 id="github">GitHub</h3>

<p><a href="https://github.com/">GitHub</a>で以下を管理している。</p>

<ul>
<li><a href="https://github.com/mazgi/sakemeshi.terraform">sakemeshi.terraform</a>

<ul>
<li>Terraformリポジトリ</li>
<li>中身はRoute 53にドメインのゾーンを登録してmoduleを呼び出しているくらい</li>
<li>AWSのcredential等は <code>sakemeshi.terraform-secret</code> リポジトリに置いてsubmoduleとして参照している</li>
</ul></li>
<li><a href="https://github.com/mazgi/terraform-aws-static-website">terraform-aws-static-website</a>

<ul>
<li>自分用Terraform module</li>
<li>S3+CloudFrontでstaticなWebサイトを作るもろもろが詰まっている</li>
</ul></li>
<li>(private) sakemeshi.terraform-secret

<ul>
<li>AWSのcredentialなどが入っている</li>
<li>credential store導入とかはまた今度</li>
</ul></li>
<li>(private) sakemeshi.content

<ul>
<li>HugoによるWebサイトの中身</li>
<li>このリポジトリのmasterにpushするとCircleCIが動いてS3にdeployされる</li>
</ul></li>
</ul>

<h1 id="つくりかた">つくりかた</h1>

<p>コンセプトとしてはWebUIを手でぽちぽちしたくないのでTerraformでInfra as Codeします！</p>

<h2 id="aws-webコンソールぽちぽち">AWS Webコンソールぽちぽち</h2>

<p>最初からコンセプトに反するようだが2018年時点では手でポチポチすることもまだ必要なのです。(あるいはCLI)<br />
作るものは2つ。</p>

<h3 id="terraform-実行用-iam-user">Terraform 実行用 IAM User</h3>

<p><code>terraform-admin</code> という名前で <code>AdministratorAccess</code> をattacheしたIAMユーザーを作る。<br />
credentialも払い出して、今回の場合は <code>sakemeshi.terraform-secret</code> リポジトリにpushしておく。</p>


<figure>
    
        <img src="/posts/2018.02/s3&#43;cloudfront-website-with-terraform-and-circleci/0002.png" />
    
    
</figure>


<h3 id="tfstate-格納用-s3-bucket">tfstate 格納用 S3 Bucket</h3>

<p>Terraformは設定したクラウド環境の状態を <code>tfstate</code> というファイルで管理するのでそれを格納するS3バケットを作る。</p>

<p>バケット名は <code>${AWSアカウント名}-terraform</code> としてバージョニングを有効にする。<br />
先ほど作ったIAMユーザー <code>terraform-admin</code> からアクセスできれば良い。</p>


<figure>
    
        <img src="/posts/2018.02/s3&#43;cloudfront-website-with-terraform-and-circleci/0003.png" />
    
    
</figure>


<p>詳しくは以下参照。</p>

<p><a href="https://www.terraform.io/docs/backends/types/s3.html">Backend Type: s3 - Terraform by HashiCorp</a></p>

<h2 id="infra-as-terraform">Infra as Terraform</h2>

<h3 id="インフラをコードで書く">インフラをコードで書く</h3>

<p>Terraformで構築するもろもろは専用のGitHubリポジトリを作って <code>terraform.tf</code> に書く。<br />
先述の通りここで公開している。</p>

<p><a href="https://github.com/mazgi/sakemeshi.terraform">mazgi/sakemeshi.terraform</a></p>

<p>主な内容は以下の通り。</p>

<ul>
<li><code>prepare.sh</code>

<ul>
<li>terraformバイナリのダウンロードと展開</li>
<li>必要な環境変数のexport</li>
<li>なお命名は職場の文化に由来する</li>
</ul></li>
<li><code>terraform.tf</code>

<ul>
<li>Terraformで行いたいもろもろ</li>
<li>ただしほとんどはmoduleに追い出しているので、実際の内容はRoute 53のゾーン設定とmoduleの読み出し程度</li>
</ul></li>
<li><code>terraform.tfvars</code>

<ul>
<li>後述のprivateなcredentialリポジトリ内へのsymlink</li>
<li>AWSのACCESS_KEYやSECRET_KEYなどが書かれている</li>
</ul></li>
</ul>

<p><code>terraform.tf</code> で参照しているmoduleは公開しているが後述のエラーやリージョンが固定などの残課題がある。</p>

<p><a href="https://registry.terraform.io/modules/mazgi/static-website/aws/0.0.2">Terraform Module Registry | mazgi/static-website/aws</a></p>

<p>先述の通りTerraformを実行するIAMユーザーのcredential等は別のprivateリポジトリを作って配置している。<br />
公開できないが中身はこの程度。</p>


<figure>
    
        <img src="/posts/2018.02/s3&#43;cloudfront-website-with-terraform-and-circleci/0004.png" />
    
    
</figure>


<h3 id="terraform-実行">Terraform 実行</h3>

<p>ようやくTerraformを実行できる環境が整ったので実行！<br />
なお <code>prepare.sh</code> は環境変数をexportするので必ず <code>source</code> する。</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ source prepare.sh
$ bin/terraform apply</code></pre></div>

<p>実行すると初回はもろもろのリソースが作られ、1件のエラーが発生する。<br />
2回目以降はこのように1件のエラーが発生する。。<br />
後述する。</p>


<figure>
    
        <img src="/posts/2018.02/s3&#43;cloudfront-website-with-terraform-and-circleci/0005.png" />
    
    
</figure>


<p>細かいことを書くと今回のドメイン自体はRoute 53で管理していないため、別途ネームサーバーをRoute 53に向けておく等の手順が必要です。</p>

<h2 id="circleciで自動build-deploy">CircleCIで自動build &amp;&amp; deploy</h2>

<p>Terraformで空のWebサイトができたので中身を作っていく。</p>

<p>GitHubリポジトリを用意しておもむろに <code>hugo new site .</code> する。<br />
適当なテーマをsubmoduleとして追加する。<br />
<a href="https://gohugo.io/getting-started/quick-start/">Quick Start</a>通り。</p>

<p>Hugoは今後がんばることにして今回はCircleCI 2.0をがんばる。<br />
結論を書くと<a href="https://gist.github.com/mazgi/6c0dd922f89eee80fe5da6317d7e7aed">こういう <code>.circleci/config.yml</code> </a>を書いた。<br />
ハマった。</p>

<p>そのほかは本当に <code>hugo new site .</code> したまま。</p>


<figure>
    
        <img src="/posts/2018.02/s3&#43;cloudfront-website-with-terraform-and-circleci/0006.png" />
    
    
</figure>


<p>何はともあれこれでCircleCIでのWebサイトのビルドとS3への同期が行えるようになった！めでたい！</p>


<figure>
    
        <img src="/posts/2018.02/s3&#43;cloudfront-website-with-terraform-and-circleci/0007.png" />
    
    
</figure>


<h1 id="おわりに">おわりに</h1>

<p>ということで(ほぼ)手でぽちぽちせずにInfrastructure as CodeでstaticなWebサイトが作れたし更新の仕組みもできた！やったね！</p>

<h2 id="ポイント">ポイント</h2>

<p>以下あまり書けてないので機会があったら書く。</p>

<h3 id="terraform">Terraform</h3>

<ul>
<li>最近のTerraformは <code>terraform init</code> が必要

<ul>
<li>その作業ディレクトリでの初回実行やmoduleのバージョン上げた際など</li>
</ul></li>
<li>最近のTerraformは <code>terraform apply</code> したあと本当に実行するか聞いてくる

<ul>
<li>そのため <code>terraform apply[ENTER]</code> してコーヒーを買いにいくと何十分後に戻っても <code>Do you want to perform these actions?</code> というメッセージが出迎えてくれる(もちろんあなたのクラウド環境には何も変化はない)</li>
<li><code>terraform apply -auto-approve</code> というわるいオプションがある</li>
</ul></li>
<li>tfstate格納用S3バケット(S3 backend)を使うためには環境変数or <code>~/.aws</code> 内にcredentialが必要

<ul>
<li>私は <code>prepare.sh</code> の中でexportしている(ので必ず <code>source</code> する)</li>
</ul></li>
<li>ACMの検証が従来のメールだけではなくDNSでもできるようになっていてTerraformでも対応していた

<ul>
<li><a href="https://github.com/terraform-providers/terraform-provider-aws/pull/2813">New Resources: aws_acm_certificate and aws_acm_certificate_validation by flosell · Pull Request #2813 · terraform-providers/terraform-provider-aws</a></li>
<li>これのおかげで <code>terraform apply</code> だけで証明書発行してIssuedになるところまで実現できた</li>
<li>ただし<a href="https://github.com/mazgi/terraform-aws-static-website/blob/v0.0.2/main.tf#L9"> <code>AWS provider 1.9</code> 以上が必要</a></li>
</ul></li>
</ul>

<h3 id="circleci-2-0">CircleCI 2.0</h3>

<ul>
<li>Docker便利だけども

<ul>
<li>使うDockerイメージにもよるが当然 <code>curl</code> も <code>git</code> も入ってなかったりする</li>
<li>自分用Dockerイメージ作りたくなる</li>
<li>開発環境がDocker Hubに公開できるDockerイメージで完結している場合は便利そう</li>
</ul></li>
<li><code>checkout</code> に <code>git clone --recursive</code> 相当の機能がない(?)

<ul>
<li>そのため<a href="https://github.com/mazgi/sakemeshi.content/blob/master/.circleci/config.yml#L20-L21"><code>checkout</code> の次の行で <code>git submodule update</code> を書いた</a></li>
</ul></li>
</ul>

<h2 id="特に-ハマりどころ">(特に)ハマりどころ</h2>

<h3 id="terraform-apply-時の-aws-acm-certificate-validation-エラー">terraform apply 時の aws_acm_certificate_validation エラー</h3>

<p><code>terraform apply</code> する際に毎回このエラーが発生する。</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">Error: Error applying plan:

<span style="color:#ae81ff">1</span> error<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span> occurred:

* module.static-website.aws_acm_certificate_validation.website: <span style="color:#ae81ff">1</span> error<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span> occurred:

* aws_acm_certificate_validation.website: Certificate needs <span style="color:#f92672">[</span>VALIDATON_RECORD.YOURDOMAIN VALIDATON_RECORD.YOURDOMAIN<span style="color:#f92672">]</span> to be set but only <span style="color:#f92672">[</span>VALIDATON_RECORD.YOURDOMAIN<span style="color:#f92672">]</span> was passed to validation_record_fqdns</code></pre></div>

<p>これ <code>YOURDOMAIN</code> と <code>*.YOURDOMAIN</code> でバリデーションレコードが同じで、Route 53上は1レコードしかないものをTerraformの<a href="https://github.com/terraform-providers/terraform-provider-aws/blob/v1.9.0/aws/resource_aws_acm_certificate_validation.go">AWS provider</a>が2レコード返ってくることを期待しているように見えるんだけどどうしたものか。</p>

<h3 id="circleci-2-0-で-attach-workspace-するために-ca-certificates-パッケージが必要">CircleCI 2.0 で attach_workspace するために ca-certificates パッケージが必要</h3>

<p>前フェイズで永続化したワークスペースを後フェイズで <code>attach_workspace</code> して取り出すために <code>ca-certificates</code> パッケージ必要なのはハマった。<br />
こちらの記事に助けられた。</p>

<p><a href="https://qiita.com/gcoka/items/8a9cd59fec324a1fca19">CircleCIでx509という証明書エラーに遭遇したときの対処 - Qiita</a></p>

<p>それはそうと再掲するが <code>.circleci/config.yml</code> がこんな長さになった。つらい。<br />
workflowとしてbuildとdeployが分かれるのは綺麗だけども。。</p>

<script src="//gist.github.com/mazgi/6c0dd922f89eee80fe5da6317d7e7aed.js"></script>

<p>ともかくこういうサイトをいくつか作りたいニーズがあったのでやっていきます。</p>

    </article>
    
    <hr/>
    
    
    <article>
      <div class="row">
        <h1><a href="/posts/2017.12/technical-docs-with-hugo/">簡易な技術ドキュメントをHugoで書くと便利だった</a></h1>
      </div>
      

<p>サンプルコードのドキュメントを<a href="https://gohugo.io/">Hugo</a>で書いてサンプルコードと一緒に配ったら便利そうだったのでやってみた。</p>

<h2 id="やりたいこと">やりたいこと</h2>

<p>仕事で他社さんにサンプルコードとドキュメントをセットでお渡ししたいのだけど社ではGitHub Enterpriseを使っているのでリポジトリを直接見ていただくことが難しいケースがある。</p>

<p>規模が大きいプロジェクトなら<a href="http://www.sphinx-doc.org/">Sphinx</a>使うと(やる気次第で)いくらでも綺麗なドキュメントが書けそうではあるけど、規模がそれほどじゃないうちはサクッとMarkdownで書いて、でもソースコードとドキュメントが整合性取れててほしいという気持ちになる。<br />
(今は<a href="http://www.sphinx-doc.org/en/stable/markdown.html">SphinxもMarkdownで書ける</a>そうだ、最近知った)</p>

<p>そもそも(私は)ドキュメント書きたくないので、できるだけスクリプトの提供やソースコードコメントで賄って文章量は最小限に抑えたいというモチベーションもあった。</p>

<p>そこで以下のような作戦を考えた。</p>

<h3 id="さくせん">さくせん</h3>

<ul>
<li>ドキュメントはHugoでプレビューしながらMarkdownで書く</li>
<li>生成したHTMLは <code>/docs</code> ディレクトリに突っ込む</li>
<li>社内向けにはGitHub PagesでmasterのHEADをホスティングする</li>
<li>社外向けには最新リリースのアーカイブを提供する</li>
</ul>

<p>プレビューできるから書くの楽だし、tag打てるからソースコードとドキュメントの整合性も取りやすい。きっと便利！</p>

<h2 id="できたもの">できたもの</h2>

<ul>
<li>リポジトリ: <a href="https://github.com/mazgi/example-document-with-hugo">https://github.com/mazgi/example-document-with-hugo</a></li>
<li>GitHub Pages: <a href="https://mazgi.github.io/example-document-with-hugo/index.html">https://mazgi.github.io/example-document-with-hugo/index.html</a></li>
</ul>

<p>テーマはこちらを使わせていただいた。<br />
サイドバーでエントリが一覧できて技術ドキュメントらしさがある。<br />
<a href="https://github.com/vjeantet/hugo-theme-docdock">https://github.com/vjeantet/hugo-theme-docdock</a></p>

<h2 id="工夫">工夫</h2>

<p><a href="https://github.com/mazgi/example-document-with-hugo/blob/master/docs.source/config.toml">設定ファイルはこれ。</a></p>

<ul>
<li>以下で生成したHTML内のリンクが <code>/</code> からの相対PATHになるふいんき(ちゃんと調べていない)

<ul>
<li><code>baseURL = &quot;/&quot;</code></li>
<li><code>relativeURLs = true</code></li>
<li><code>uglyurls = true</code></li>
</ul></li>
<li>themeの指定</li>
</ul>

<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-toml" data-lang="toml"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;display:block;color:#7c7c79"> 1</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;display:block;color:#7c7c79"> 2</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;display:block;color:#7c7c79"> 3</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;display:block;color:#7c7c79"> 4</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;display:block;color:#7c7c79"> 5</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;display:block;color:#7c7c79"> 6</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;display:block;color:#7c7c79"> 7</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;display:block;color:#7c7c79"> 8</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;display:block;color:#7c7c79"> 9</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;display:block;color:#7c7c79">10</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;display:block;color:#7c7c79">11</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-toml" data-lang="toml"><span style="color:#a6e22e">baseURL</span> = <span style="color:#e6db74">&#34;/&#34;</span>
<span style="color:#a6e22e">languageCode</span> = <span style="color:#e6db74">&#34;en-us&#34;</span>
<span style="color:#a6e22e">DefaultContentLanguage</span> = <span style="color:#e6db74">&#34;en&#34;</span>
<span style="color:#a6e22e">title</span> = <span style="color:#e6db74">&#34;Example Document with Hugo&#34;</span>
<span style="color:#a6e22e">publishDir</span> = <span style="color:#e6db74">&#34;../docs&#34;</span>
<span style="color:#a6e22e">relativeURLs</span> = <span style="color:#66d9ef">true</span>
<span style="color:#a6e22e">uglyurls</span> = <span style="color:#66d9ef">true</span>
<span style="color:#a6e22e">theme</span> = <span style="color:#e6db74">&#34;docdock&#34;</span>

[<span style="color:#a6e22e">params</span>]
<span style="color:#a6e22e">themeVariant</span> = <span style="color:#e6db74">&#34;gray&#34;</span></code></pre></td></tr></table>
</div>
</div>

<p>また、この設定ファイルとドキュメントのソースコード(Markdown他)を <code>/docs.source</code> に置き、 <code>publishDir = &quot;../docs&quot;</code> と設定することでリポジトリのrootにあまりファイルを置かないようにしている。<br />
これはこのリポジトリにサンプルコードも同居する想定であり、rootにファイルが増えて見通しがわるくなることを避けるため。</p>

<p>HTMLを生成してcommitしてpushしてtagを打ったものがこちら。<br />
<a href="https://github.com/mazgi/example-document-with-hugo/releases/tag/v0.0.1">https://github.com/mazgi/example-document-with-hugo/releases/tag/v0.0.1</a></p>

<p>アーカイブをダウンロードして手元で開くとこんな感じで <code>index.html</code> が見える。<br />
アーカイブファイルにも展開後のディレクトリにもバージョンナンバーが含まれわかりやすい。</p>


<figure>
    
        <img src="/posts/2017.12/technical-docs-with-hugo/0001.png" />
    
    
</figure>


<p><code>index.html</code> もリンク先のドキュメントもブラウザで表示できる。便利。</p>


<figure>
    
        <img src="/posts/2017.12/technical-docs-with-hugo/0002.png" />
    
    
</figure>


    </article>
    
    <hr/>
    
    
    <article>
      <div class="row">
        <h1><a href="/posts/2017.12/dockerimage-for-chainermn-on-v100/">EC2 P3で使えるChainerMN入りのDockerイメージを作った</a></h1>
      </div>
      

<p>sonots先生によるこの記事をやってみたという話です。</p>

<p><a href="https://qiita.com/sonots/items/ee247a2e36033646c914">docker (nvidia-docker) を使ってマルチノードで ChainerMN を実行する方法(仮) - Qiita</a></p>

<h2 id="概要">概要</h2>

<p>Dockerfileはここにあります。</p>

<p><a href="https://github.com/mazgi/docker-cuda-cv">mazgi/docker-cuda-cv: based on: https://gitlab.com/nvidia/cuda</a></p>

<p>ベースはNVIDIAさんのオフィシャルイメージです。</p>

<p><a href="https://hub.docker.com/r/nvidia/cuda/">https://hub.docker.com/r/nvidia/cuda/</a></p>

<h2 id="実行結果">実行結果</h2>

<p>ChainerMNのexampleを試した結果はこちら。<br />
今のところシングルNodeシングルGPUとシングルNodeマルチGPUしか試してないです。</p>

<script src="//gist.github.com/mazgi/e095e4756f14ebb9db5c26cd70b23c63.js"></script>

<p>手順はこちらの通りなんですが時間が取れていない&hellip;</p>

<p><a href="https://qiita.com/sonots/items/ee247a2e36033646c914#%E3%83%9E%E3%83%AB%E3%83%81%E3%83%8E%E3%83%BC%E3%83%89">docker (nvidia-docker) を使ってマルチノードで ChainerMN を実行する方法(仮) - Qiita</a></p>

<p>P3じゃなくても動くはずですが、ホスト側にGPUとnvidia-dockerは必要です。<br />
今回は社の環境で試したのでsonots便利先生環境の恩恵を受けてます🙏</p>

<p><a href="http://blog.livedoor.jp/sonots/archives/49502478.html">DeNA TechCon 2017 と Developers Summit 2017 でDeNAの機械学習基盤と分析基盤の講演をしました - sonots:blog</a></p>

<p>イチから構築する場合はこういう記事が参考になりそう。</p>

<p><a href="http://chie8842.hatenablog.com/entry/2017/11/27/221551">p3インスタンス(V100)上でCUDA+CUDNN+Tensorflowを動かすのが大変だったのできろく。 - 焼肉が食べたい</a></p>

<h2 id="経緯とか">経緯とか</h2>

<p>めでたく記事も出たので色々言えるようになったのですが、実はありがたいことにP3の先行検証というのをさせていただいてました。<br />
(なおイベント当日はカメラマンしてました)</p>

<p><a href="https://engineer.dena.jp/2017/12/amazon-ec2-p3pose-estimation.html">Amazon EC2 P3インスタンスにおけるPose Estimation速度向上検証 - Technology of DeNA</a></p>

<p>この検証時点ではChainerMNではなくChainerで、環境もVM上に直接作ってたのですが、その後部内から「Dockerイメージになってたほうが便利」とフィードバックいただき先行者の記事を参考に手探りしてる状況です。<br />
私はMLわからないマンなのですが、最初 cuDNN 7 + CuPy 1.0.3 で環境作ろうとしてバージョンが合わなくてどうしよ！と思ってたら「今日 cuDNN 7 対応の CuPy 2.0 リリースするよ！」と教えていただいたりとか、この業界本当に数時間単位で進歩しててすごい。</p>

<p>こういう用途だとコンテナほんと便利なんですけど、でもDockerイメージの命名むずかしい。<br />
<code>mazgi/cuda-cv:9.0-cudnn7-devel-ubuntu16.04</code> じゃなくて、<br />
<code>mazgi/cuda-cv-9.0-cudnn7-devel-ubuntu16.04:latest</code> とかにしたほうがいいのかな(長い)。<br />
そもそもの話としては実質Chainer &amp; ChainerMNイメージなのでそういう名前にすべきだし(さらに長くなる)。</p>

    </article>
    
    
  </div>
  <div class="col-lg-3">
    <ul>
      
      <li><a href="/posts/2018.03/setup-amazon-sagemaker/">Amazon SageMakerをそれなりの人数で使うときの設定</a></li>
      
      <li><a href="/posts/2018.03/s3fs-for-s3-with-sse-kms/">SSE-KMSで暗号化したS3バケットをs3fsでmountする</a></li>
      
      <li><a href="/posts/2018.02/s3&#43;cloudfront-website-with-terraform-and-circleci/">S3&#43;CloudFrontをTerraformで設定してCircleCIで更新する</a></li>
      
      <li><a href="/posts/2017.12/technical-docs-with-hugo/">簡易な技術ドキュメントをHugoで書くと便利だった</a></li>
      
      <li><a href="/posts/2017.12/dockerimage-for-chainermn-on-v100/">EC2 P3で使えるChainerMN入りのDockerイメージを作った</a></li>
      
    </ul>
  </div>
</div>
      <div class="row">
        <footer class="col-lg-12">
          <hr/>
          <span>&copy; mazgi.log</span>
          <span>&nbsp;&middot;&nbsp;</span>
          <i class="fas fa-bolt"></i>
          <span>Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a></span>
        </footer>
      </div>
    </div>
    </main>
    
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-68170979-2"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-68170979-2');
    </script>
    
      
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    
    <script defer src="https://use.fontawesome.com/releases/v5.0.8/js/all.js" integrity="sha384-SlE991lGASHoBfWbelyBPLsUlwY1GwNDJo3jSJO04KZ33K2bwfV9YBauFfnzvynJ" crossorigin="anonymous"></script>
  </body>
</html>

